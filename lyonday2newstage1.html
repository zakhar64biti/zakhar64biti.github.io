<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>WSC Day2 – راهنمای فوق‌جزئی کنسول (Stage-1 کامل)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- سبک ساده و تمیز -->
  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --ink:#0f172a; --muted:#475569;
      --brand:#2563eb; --ok:#16a34a; --warn:#d97706; --line:#e2e8f0;
      --code:#f1f5f9;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Vazirmatn,IRANSans,Segoe UI,Arial;line-height:1.75}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 14px}
    .sub{color:var(--muted);font-size:14px;margin-bottom:20px}
    .pill{display:inline-block;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;border-radius:999px;padding:2px 10px;font-size:12px;margin-inline:6px 0}
    details{background:var(--card);border:1px solid var(--line);border-radius:14px;margin:12px 0;padding:10px 14px}
    summary{cursor:pointer;font-weight:700}
    .step{border-inline-start:4px solid var(--brand);background:#fff;padding:12px;border-radius:10px;margin:12px 0}
    .num{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:8px;background:var(--brand);color:#fff;font-size:12px;margin-inline:6px}
    .mini{color:var(--muted);font-size:13px;margin-top:6px}
    code{background:var(--code);border:1px solid var(--line);border-radius:8px;padding:2px 6px}
    pre{background:var(--code);border:1px solid var(--line);border-radius:12px;padding:12px;overflow:auto}
    ul,ol{margin:8px 0 8px 0}
    .callout{border:1px solid var(--line);border-radius:12px;background:#fff;padding:12px}
    .ok{border-color:#bbf7d0;background:#f0fdf4}
    .warn{border-color:#fde68a;background:#fffbeb}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .col6{grid-column:span 6}
    .col12{grid-column:span 12}
    @media (max-width:900px){.col6{grid-column:span 12}}
    .kbd{border:1px solid var(--line);border-bottom-width:3px;border-radius:8px;padding:2px 6px;background:#fff;font-family:ui-monospace,monospace}
    .topbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
    .btn:hover{border-color:var(--brand)}
    .muted{color:var(--muted)}
    .tight li{margin:4px 0}
    .path{font-family:ui-monospace,monospace;background:var(--code);border:1px solid var(--line);border-radius:8px;padding:3px 6px}
    .hr{height:1px;background:var(--line);margin:16px 0}
  </style>
  <script>
    // کلید میانبر: Shift+S => باز/بسته کردن همهٔ details
    document.addEventListener('keydown',(e)=>{
      if(e.key.toLowerCase()==='s' && e.shiftKey){
        const all=[...document.querySelectorAll('details')];
        const hasClosed=all.some(d=>!d.open);
        all.forEach(d=>d.open=hasClosed);
      }
    });
    function toggleAll(open){document.querySelectorAll('details').forEach(d=>d.open=open);}
  </script>
</head>
<body>
  <div class="wrap">
    <h1>WSC 2024 – Day 2 (TP53)</h1>
    <div class="sub">
      راهنمای فوق‌جزئی «فقط از طریق کنسول». <span class="pill">Region: us-east-1</span>
      <span class="pill">EKS ممنوع</span> <span class="pill">ECS توصیه‌شده</span>
    </div>

    <div class="topbar">
      <button class="btn" onclick="toggleAll(true)">باز کردن همه</button>
      <button class="btn" onclick="toggleAll(false)">بستن همه</button>
      <span class="muted">میانبر: <span class="kbd">Shift</span> + <span class="kbd">S</span></span>
    </div>

    <!-- قوانین کلیدی -->
    <div class="callout warn">
      <b>الزامات کلیدی سناریو (خلاصه):</b>
      <ul class="tight">
        <li>داده فشارخون → Kinesis → Kinesis Data Analytics (آنومالی) → DynamoDB (<code>cloudraiser-iot</code>)</li>
        <li>آیتم‌های DynamoDB قدیمی‌تر از ۴۸ ساعت حذف (TTL)</li>
        <li>تحلیل تاریخی آنومالی‌ها در Redshift (غیر Serverless)</li>
        <li>داده بیزینس در Aurora (غیر Serverless)، یک API GET برای برگرداندن val1..val10</li>
        <li>وب‌سرویس خروجی DynamoDB با باینری رسمی (x86/AL2)، اجرای Backend روی ECS توصیه می‌شود</li>
      </ul>
    </div>

    <!-- ========================= Stage 0 ========================= -->
    <details open>
      <summary>Stage 0 — پیش‌نیازهای شبکه و حساب (خیلی ریز)</summary>
      <div class="step">
        <span class="num">0.1</span><b>VPC پایه:</b>
        <div class="mini">مسیر: <span class="path">VPC → Your VPCs → Create VPC → VPC and more</span></div>
        <ol>
          <li>نام: <code>wsc-day2</code></li>
          <li>IPv4 CIDR: <code>10.0.0.0/16</code></li>
          <li>AZها: <code>us-east-1a</code> و <code>us-east-1b</code></li>
          <li>Subnets: 2 پابلیک (a,b) + 2 پرایوت (a,b). هر کدام /24</li>
          <li>Internet Gateway بساز و به VPC وصل کن (برای پابلیک‌ها)</li>
          <li>NAT Gateway در یکی از پابلیک‌ها بساز؛ Route خصوصی‌ها به NAT بده</li>
        </ol>
      </div>

      <div class="step">
        <span class="num">0.2</span><b>VPC Endpoints (کاهش خروجی اینترنت):</b>
        <div class="mini">مسیر: <span class="path">VPC → Endpoints → Create</span></div>
        <ul class="tight">
          <li>Gateway: <code>com.amazonaws.us-east-1.s3</code>, <code>…dynamodb</code></li>
          <li>Interface: <code>…kinesis-streams</code>, <code>…logs</code></li>
          <li>Security Group برای Interface Endpointها بساز (فقط از ساب‌نت‌های اپ اجازه بده)</li>
        </ul>
      </div>

      <div class="step">
        <span class="num">0.3</span><b>CloudWatch Log Groups:</b>
        <div class="mini">مسیر: <span class="path">CloudWatch → Logs → Log groups → Create</span></div>
        <ul class="tight">
          <li><code>/wsc/day2/kinesis-analytics</code></li>
          <li><code>/wsc/day2/lambda-ddb-sink</code></li>
          <li><code>/wsc/day2/ecs/web</code></li>
          <li><code>/wsc/day2/api</code></li>
        </ul>
      </div>
    </details>

    <!-- ========================= Stage 1 ========================= -->
    <details open>
      <summary>Stage 1 — Data Reception (Kinesis → KDA → DynamoDB) – فوق‌جزئی</summary>

      <!-- DDB -->
      <div class="step">
        <span class="num">1.1</span><b>ساخت DynamoDB Table (خروجی Real-Time):</b>
        <div class="mini">مسیر: <span class="path">DynamoDB → Tables → Create table</span></div>
        <ol>
          <li>Table name: <code>cloudraiser-iot</code></li>
          <li>Partition key: <code>No</code> (Type: String)</li>
          <li>Provisioning: <b>On-demand</b> (برای تمرین سریع)</li>
          <li><i>(اختیاری)</i> Point-in-time recovery: فعلاً خاموش (هزینه)</li>
          <li>ایجاد جدول را تأیید کن</li>
        </ol>
        <div class="callout ok">
          <b>ساختار آیتم پیشنهادی:</b>
          <pre>{
  "No": "BP-00123",
  "Systolic": "168",
  "Diastolic": "101",
  "Score": "2.31",
  "ts":  "2025-10-18T18:20:03Z",
  "expireAt": 1730000000  // epoch seconds (اکنون + 48 ساعت)
}</pre>
        </div>
      </div>

      <div class="step">
        <span class="num">1.2</span><b>فعال‌سازی TTL برای حذف آیتم‌های &gt;48h:</b>
        <div class="mini">مسیر: <span class="path">DynamoDB → Tables → cloudraiser-iot → Additional settings → Time to live (TTL)</span></div>
        <ol>
          <li>Attribute name را <code>expireAt</code> وارد کن</li>
          <li>Enable را بزن</li>
          <li>چند دقیقه طول می‌کشد تا وضعیت Enabled شود</li>
        </ol>
      </div>

      <!-- Kinesis Streams -->
      <div class="step">
        <span class="num">1.3</span><b>ایجاد Kinesis Data Stream (ورود داده فشارخون):</b>
        <div class="mini">مسیر: <span class="path">Kinesis → Data streams → Create data stream</span></div>
        <ol>
          <li>Stream name: <code>bp-stream</code></li>
          <li>Capacity mode: <b>On-demand</b></li>
          <li>سایر گزینه‌ها پیش‌فرض → Create</li>
        </ol>
        <div class="mini">برای تست بعداً از تب <b>Test</b> خود کنسول هم می‌تونی رکورد بفرستی.</div>
      </div>

      <!-- KDA (SQL) -->
      <div class="step">
        <span class="num">1.4</span><b>ایجاد Kinesis Data Analytics (SQL) برای تشخیص آنومالی:</b>
        <div class="mini">مسیر: <span class="path">Kinesis Data Analytics → Create application → SQL</span></div>
        <ol>
          <li>Application name: <code>bp-anomaly-sql</code></li>
          <li>Source: <code>bp-stream</code> را انتخاب کن</li>
          <li>Discover schema → فیلدهای ورودی را ببین/تأیید کن (مثال: <code>no,systolic,diastolic,ts</code>)</li>
          <li>Log delivery: ارسال لاگ به <code>/wsc/day2/kinesis-analytics</code></li>
          <li>Create</li>
        </ol>
        <div class="callout">
          <b>منطق سادهٔ آنومالی (بدون رگرسیون/RCF برای شروع):</b>
          <ul class="tight">
            <li>اگر <code>systolic &gt; 160</code> یا <code>diastolic &gt; 100</code> ⇒ رکورد «مشکوک»</li>
            <li>بعداً می‌تونی با Templateهای Random Cut Forest جایگزین کنی</li>
          </ul>
          <pre>-- نمونه ساده: فقط رکوردهای مشکوک را به خروجی بده
CREATE OR REPLACE STREAM suspicious AS
SELECT STREAM no, systolic, diastolic,
       CAST(systolic*0.01 + diastolic*0.01 AS DOUBLE) AS score,
       ts
FROM SOURCE_SQL_STREAM_001
WHERE systolic > 160 OR diastolic > 100;</pre>
        </div>
      </div>

      <!-- Lambda Sink -->
      <div class="step">
        <span class="num">1.5</span><b>Lambda برای نوشتن خروجی KDA در DynamoDB:</b>
        <div class="mini">مسیر: <span class="path">Lambda → Create function → Author from scratch</span></div>
        <ol>
          <li>Name: <code>kda-ddb-sink</code>, Runtime: <b>Python 3.12</b></li>
          <li>Permissions: یک Role جدید بساز با Policy‌های:
            <ul class="tight">
              <li><code>AmazonDynamoDBFullAccess</code> (برای تمرین سریع) یا حداقلی: <code>dynamodb:PutItem</code> روی جدول</li>
              <li><code>CloudWatchLogsFullAccess</code> (تمرینی)</li>
            </ul>
          </li>
          <li>Environment variables:
            <ul class="tight">
              <li><code>TABLE_NAME = cloudraiser-iot</code></li>
              <li><code>TTL_HOURS = 48</code></li>
            </ul>
          </li>
          <li>کد زیر را جایگزین کن و Deploy بزن:</li>
        </ol>
        <pre>import os, json, time, base64
import boto3
ddb = boto3.resource("dynamodb").Table(os.getenv("TABLE_NAME","cloudraiser-iot"))
TTL_HOURS = int(os.getenv("TTL_HOURS","48"))

def lambda_handler(event, context):
    # ورودی KDA (AWS → Lambda) معمولاً شامل records با data base64 است
    # ساختار می‌تواند بسته به تنظیمات Output تغییر کند؛ این نسخه عمومی است.
    ok, fail = 0, 0
    for rec in event.get("records", []):
        try:
            raw = base64.b64decode(rec["data"]).decode("utf-8")
            d = json.loads(raw) if raw.strip().startswith("{") else _parse_csv(raw)
            item = {
                "No": str(d.get("no") or d.get("No")),
                "Systolic": str(d.get("systolic") or d.get("Systolic")),
                "Diastolic": str(d.get("diastolic") or d.get("Diastolic")),
                "Score": str(d.get("score", "")),
                "ts": d.get("ts") or time.strftime("%Y-%m-%dT%H:%M:%SZ", time.gmtime()),
                "expireAt": int(time.time()) + TTL_HOURS*3600
            }
            ddb.put_item(Item=item)
            ok += 1
        except Exception as e:
            fail += 1
    return {"ok": ok, "failed": fail}

def _parse_csv(s):
    # اگر خروجی‌ت CSV ساده باشد: no,systolic,diastolic,score,ts
    parts = [x.strip() for x in s.split(",")]
    keys = ["no","systolic","diastolic","score","ts"]
    return {k: (parts[i] if i < len(parts) else "") for i,k in enumerate(keys)}</pre>
      </div>

      <div class="step">
        <span class="num">1.6</span><b>اتصال KDA → Lambda به‌عنوان Destination:</b>
        <div class="mini">مسیر: <span class="path">Kinesis Data Analytics → bp-anomaly-sql → Destinations → Add</span></div>
        <ol>
          <li>Destination: <b>Lambda function</b> و <code>kda-ddb-sink</code> را انتخاب کن</li>
          <li>IAM permission لینک خودکار را تأیید کن</li>
          <li>Save / Update را بزن و <b>Start application</b></li>
        </ol>
      </div>

      <!-- Test -->
      <div class="step ok">
        <span class="num">1.7</span><b>تست End-to-End (بدون CLI، فقط کنسول):</b>
        <ol>
          <li>مسیر: <span class="path">Kinesis → Data streams → bp-stream → Test</span></li>
          <li>یک رکورد JSON نمونه بفرست:
            <pre>{
  "no":"BP-00123","systolic":168,"diastolic":101,"ts":"2025-10-18T18:20:03Z"
}</pre>
          </li>
          <li>چند رکورد دیگر با مقادیر مختلف بفرست</li>
          <li>CloudWatch → Logs:
            <ul class="tight">
              <li><code>/wsc/day2/kinesis-analytics</code> را بازبینی کن (هر خطای SQL/اسکیما)</li>
              <li><code>/wsc/day2/lambda-ddb-sink</code> را چک کن (ok/failed)</li>
            </ul>
          </li>
          <li>DynamoDB → Tables → <code>cloudraiser-iot</code> → <b>Explore items</b> → رکوردها را ببین</li>
        </ol>
      </div>

      <!-- Common Errors -->
      <div class="callout">
        <b>خطاهای رایج و رفع سریع:</b>
        <ul>
          <li><b>AccessDenied در Lambda → DDB:</b> Policy حداقلی <code>dynamodb:PutItem</code> روی ARN جدول اضافه کن</li>
          <li><b>خالی بودن رکوردها در Lambda:</b> فرمت خروجی KDA با parsing کد هماهنگ نیست → <code>_parse_csv</code> یا JSON را تطبیق بده</li>
          <li><b>KDA در حالت Stopped:</b> حتماً <b>Start</b> بزن؛ بعد از تغییرات SQL، <b>Save &amp; Update</b> و دوباره Start</li>
          <li><b>TTL کار نمی‌کند:</b> مقدار <code>expireAt</code> باید epoch seconds باشد و ویژگی TTL دقیقاً همین نام را فعال کرده باشی</li>
        </ul>
      </div>
    </details>

    <!-- Cleanup -->
    <details>
      <summary>Cleanup — جلوگیری از هزینه</summary>
      <div class="step">
        <span class="num">C</span>اگر فقط Stage-1 را تمرین کردی:
        <ul class="tight">
          <li>Stop → Delete: Kinesis App (KDA), Data Stream</li>
          <li>حذف Lambda <code>kda-ddb-sink</code> (اگر لازم نیست)</li>
          <li>DynamoDB: حذف جدول تمرینی (یا نگه‌دار)</li>
          <li>CloudWatch Log groups غیرضروری را پاک کن</li>
        </ul>
      </div>
    </details>

    <div class="hr"></div>
    <div class="callout ok">
      اگر این سبک و جزئیات اوکیه، دقیقاً با همین قالب می‌رم سراغ:
      <ul class="tight">
        <li><b>Stage-2A:</b> وب‌سرویس خروجی DynamoDB روی ECS (باینری رسمی از S3، Task/Service/ALB، Health Check، Log)</li>
        <li><b>Stage-2B:</b> Aurora غیر Serverless + API GET (API GW + Lambda + RDS Proxy + Secrets Manager)</li>
        <li><b>Stage-3:</b> مانیتورینگ (Dashboard/Alarm/X-Ray)، بهینه‌سازی هزینه، WAF روی ALB یا API</li>
      </ul>
    </div>

  </div>
</body>
</html>
