<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>WSC Day2 â€“ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ ÙÙˆÙ‚â€ŒØ¬Ø²Ø¦ÛŒ Ú©Ù†Ø³ÙˆÙ„ (Stage-0..3 Ú©Ø§Ù…Ù„)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Ø³Ø¨Ú© Ø³Ø§Ø¯Ù‡ Ùˆ ØªÙ…ÛŒØ² -->
  <style>
    :root{
      --bg:#f8fafc; --card:#ffffff; --ink:#0f172a; --muted:#475569;
      --brand:#2563eb; --ok:#16a34a; --warn:#d97706; --line:#e2e8f0;
      --code:#f1f5f9;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Vazirmatn,IRANSans,Segoe UI,Arial;line-height:1.75}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 14px}
    .sub{color:var(--muted);font-size:14px;margin-bottom:20px}
    .pill{display:inline-block;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;border-radius:999px;padding:2px 10px;font-size:12px;margin-inline:6px 0}
    details{background:var(--card);border:1px solid var(--line);border-radius:14px;margin:12px 0;padding:10px 14px}
    summary{cursor:pointer;font-weight:700}
    .step{border-inline-start:4px solid var(--brand);background:#fff;padding:12px;border-radius:10px;margin:12px 0}
    .num{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:8px;background:var(--brand);color:#fff;font-size:12px;margin-inline:6px}
    .mini{color:var(--muted);font-size:13px;margin-top:6px}
    code{background:var(--code);border:1px solid var(--line);border-radius:8px;padding:2px 6px}
    pre{background:var(--code);border:1px solid var(--line);border-radius:12px;padding:12px;overflow:auto}
    ul,ol{margin:8px 0 8px 0}
    .callout{border:1px solid var(--line);border-radius:12px;background:#fff;padding:12px}
    .ok{border-color:#bbf7d0;background:#f0fdf4}
    .warn{border-color:#fde68a;background:#fffbeb}
    .tight li{margin:4px 0}
    .path{font-family:ui-monospace,monospace;background:var(--code);border:1px solid var(--line);border-radius:8px;padding:3px 6px}
    .hr{height:1px;background:var(--line);margin:16px 0}
    .kbd{border:1px solid var(--line);border-bottom-width:3px;border-radius:8px;padding:2px 6px;background:#fff;font-family:ui-monospace,monospace}
    .btn{border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer}
    .btn:hover{border-color:var(--brand)}
  </style>
  <script>
    // Ù…ÛŒØ§Ù†Ø¨Ø±: Shift+S => Ø¨Ø§Ø²/Ø¨Ø³ØªÙ‡ Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡Ù” details
    document.addEventListener('keydown',(e)=>{
      if(e.key.toLowerCase()==='s' && e.shiftKey){
        const all=[...document.querySelectorAll('details')];
        const hasClosed=all.some(d=>!d.open);
        all.forEach(d=>d.open=hasClosed);
      }
    });
    function toggleAll(open){document.querySelectorAll('details').forEach(d=>d.open=open);}
  </script>
</head>
<body>
  <div class="wrap">
    <h1>WSC 2024 â€“ Day 2 (TP53)</h1>
    <div class="sub">
      Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ ÙÙˆÙ‚â€ŒØ¬Ø²Ø¦ÛŒ Â«ÙÙ‚Ø· Ø§Ø² Ø·Ø±ÛŒÙ‚ Ú©Ù†Ø³ÙˆÙ„Â». <span class="pill">Region: us-east-1</span>
      <span class="pill">EKS Ù…Ù…Ù†ÙˆØ¹</span> <span class="pill">ECS ØªÙˆØµÛŒÙ‡â€ŒØ´Ø¯Ù‡</span>
      <button class="btn" onclick="toggleAll(true)">Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡</button>
      <button class="btn" onclick="toggleAll(false)">Ø¨Ø³ØªÙ† Ù‡Ù…Ù‡</button>
      <span class="mini">Ù…ÛŒØ§Ù†Ø¨Ø±: <span class="kbd">Shift</span>+<span class="kbd">S</span></span>
    </div>

    <!-- Ù‚ÙˆØ§Ù†ÛŒÙ† Ú©Ù„ÛŒØ¯ÛŒ -->
    <div class="callout warn">
      <b>Ø§Ù„Ø²Ø§Ù…Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ:</b>
      <ul class="tight">
        <li>ÙØ´Ø§Ø± Ø®ÙˆÙ† â†’ Kinesis â†’ KDA (Ø¢Ù†ÙˆÙ…Ø§Ù„ÛŒ) â†’ DynamoDB (<code>cloudraiser-iot</code>, TTL=48h)</li>
        <li>Ø¢Ù†ÙˆÙ…Ø§Ù„ÛŒâ€ŒÙ‡Ø§ÛŒ ØªØ§Ø±ÛŒØ®ÛŒ Ø¯Ø± Redshift (ØºÛŒØ± Serverless)</li>
        <li>Ø¯Ø§Ø¯Ù‡Ù” Ø¨ÛŒØ²ÛŒÙ†Ø³ Ø¯Ø± Aurora (ØºÛŒØ± Serverless) + API GET</li>
        <li>ÙˆØ¨â€ŒØ³Ø±ÙˆÛŒØ³ Ø®Ø±ÙˆØ¬ÛŒ DynamoDB Ø¨Ø§ Ø¨Ø§ÛŒÙ†Ø±ÛŒ Ø±Ø³Ù…ÛŒ (x86/AL2) Ø±ÙˆÛŒ ECS</li>
      </ul>
    </div>

    <!-- ========================= Stage 0 ========================= -->
    <details>
      <summary>Stage 0 â€” Ù¾ÛŒØ´â€ŒÙ†ÛŒØ§Ø² Ø´Ø¨Ú©Ù‡/Ù„Ø§Ú¯ (Ø®Ù„Ø§ØµÙ‡Ù” Ø±ÛŒØ²)</summary>
      <div class="step"><span class="num">0.1</span>VPC <span class="mini">Ù…Ø³ÛŒØ±: <span class="path">VPC â†’ Create VPC â†’ VPC and more</span> (2AZ, 2 pub + 2 priv, IGW/NAT)</span></div>
      <div class="step"><span class="num">0.2</span>Endpoints <span class="mini">S3/DynamoDB=GatewayØŒ Kinesis/Logs=Interface</span></div>
      <div class="step"><span class="num">0.3</span>Log groups <code>/wsc/day2/*</code></div>
    </details>

    <!-- ========================= Stage 1 ========================= -->
    <details>
      <summary>Stage 1 â€” Kinesis â†’ KDA â†’ DynamoDB (Ø®Ù„Ø§ØµÙ‡Ù” Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡)</summary>
      <div class="step">
        <span class="num">1</span>Ø¬Ø¯ÙˆÙ„ <code>cloudraiser-iot</code> Ø¨Ø§ PK=<code>No</code> (String) + TTL=<code>expireAt</code>  
        Kinesis Stream: <code>bp-stream</code> (On-demand)  
        KDA(SQL) Ø¨Ø§ Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ù‡ Lambda <code>kda-ddb-sink</code> (PutItem â†’ DDB).
      </div>
    </details>

    <!-- ========================= Stage 2A ========================= -->
    <details open>
      <summary>Stage 2A â€” ÙˆØ¨â€ŒØ³Ø±ÙˆÛŒØ³ Ø®Ø±ÙˆØ¬ÛŒ DynamoDB Ø¨Ø§ Â«Ø¨Ø§ÛŒÙ†Ø±ÛŒ Ø±Ø³Ù…ÛŒÂ» Ø±ÙˆÛŒ ECS (ÙÙ‚Ø· Ú©Ù†Ø³ÙˆÙ„)</summary>

      <div class="step">
        <span class="num">2A-1</span><b>Ø¢Ù¾Ù„ÙˆØ¯ Ø¨Ø§ÛŒÙ†Ø±ÛŒ Ø±Ø³Ù…ÛŒ Ø¨Ù‡ S3</b>
        <div class="mini">Ù…Ø³ÛŒØ±: <span class="path">S3 â†’ Create bucket</span></div>
        <ol>
          <li>Bucket: <code>wsc-day2-artifacts-YOURID</code> (Block public access Ø±ÙˆØ´Ù†)</li>
          <li>Upload: ÙØ§ÛŒÙ„ <code>stub1.zip</code> (ÛŒØ§ Ù†Ø§Ù… Ø§Ø¹Ù„Ø§Ù…â€ŒØ´Ø¯Ù‡ Ø¯Ø± Ø³Ù†Ø§Ø±ÛŒÙˆ)</li>
          <li>Versioning: Ø¨Ù‡ØªØ±Ù‡ Ø±ÙˆØ´Ù† Ø¨Ø§Ø´Ø¯</li>
        </ol>
      </div>

      <div class="step">
        <span class="num">2A-2</span><b>Ø³Ø§Ø®Øª ECS Cluster (EC2 Launch Type)</b>
        <div class="mini">Ù…Ø³ÛŒØ±: <span class="path">ECS â†’ Clusters â†’ Create</span></div>
        <ol>
          <li>Template: <b>Networking only</b></li>
          <li>Infrastructure: <b>Amazon EC2 instances</b></li>
          <li>Instance type: <code>t3.small</code>ØŒ Desired hosts: 2ØŒ Subnets: Ø®ØµÙˆØµÛŒ (a,b)</li>
          <li>Security Group (Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ):
            <ul class="tight">
              <li><b>SG-ECS-TASK</b>: ÙˆØ±ÙˆØ¯ÛŒ ÙÙ‚Ø· Ø§Ø² <b>SG-ALB</b> Ø±ÙˆÛŒ Ù¾ÙˆØ±Øª Ø¨Ø±Ù†Ø§Ù…Ù‡ (Ù¾ÛŒØ´â€ŒÙØ±Ø¶ 8080)</li>
              <li>Ø®Ø±ÙˆØ¬ÛŒ Ø¨Ø§Ø² (ÛŒØ§ Ø¨Ù‡ VPC Endpoints)</li>
            </ul>
          </li>
          <li>IAM Role Ù†ÙˆØ¯Ù‡Ø§: <b>ecsInstanceRole</b> Ø¨Ø§ Policyâ€ŒÙ‡Ø§:
            <ul class="tight">
              <li><code>AmazonEC2ContainerRegistryReadOnly</code></li>
              <li><code>AmazonSSMManagedInstanceCore</code> (Ø¨Ø±Ø§ÛŒ SSM)</li>
              <li>(Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø²) Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ S3 Ø¨Ø±Ø§ÛŒ Ú©Ø´ÛŒØ¯Ù† Ø¨Ø§ÛŒÙ†Ø±ÛŒ Ø¯Ø± Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§</li>
            </ul>
          </li>
          <li>Create</li>
        </ol>
      </div>

      <div class="step">
        <span class="num">2A-3</span><b>Task Definition (EC2) â€“ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ø§ÛŒÙ†Ø±ÛŒ Ø§Ø² S3 Ùˆ Ø§Ø¬Ø±Ø§</b>
        <div class="mini">Ù…Ø³ÛŒØ±: <span class="path">ECS â†’ Task definitions â†’ Create new â†’ EC2</span></div>
        <ol>
          <li>Task family: <code>ddb-stub-web</code>, CPU/Memory: 256/512</li>
          <li>Task Role (Ø¬Ø¯ÛŒØ¯ Ø¨Ø³Ø§Ø²): <b>taskRole-ddbweb</b> Ø¨Ø§ Policy Ø­Ø¯Ø§Ù‚Ù„ÛŒ:
            <pre>{
  "Version": "2012-10-17",
  "Statement": [
    {"Effect":"Allow","Action":["dynamodb:Query","dynamodb:Scan","dynamodb:GetItem"],"Resource":"arn:aws:dynamodb:us-east-1:ACCOUNTID:table/cloudraiser-iot"},
    {"Effect":"Allow","Action":["s3:GetObject"],"Resource":"arn:aws:s3:::wsc-day2-artifacts-YOURID/*"},
    {"Effect":"Allow","Action":["logs:CreateLogStream","logs:PutLogEvents"],"Resource":"*"}
  ]
}</pre>
          </li>
          <li>Execution Role: Ø§Ø² Ù¾ÛŒØ´â€ŒÙØ±Ø¶ <code>ecsTaskExecutionRole</code> Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†</li>
          <li>Container:
            <ul class="tight">
              <li>Image: <code>public.ecr.aws/amazonlinux/amazonlinux:2023</code> (Ù…ÛŒÙ†ÛŒÙ…Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª)</li>
              <li>Port mappings: <code>8080/tcp</code></li>
              <li>Log driver: awslogs â†’ Ú¯Ø±ÙˆÙ‡: <code>/wsc/day2/ecs/web</code></li>
              <li>Command:
                <pre>bash -lc "dnf -y install unzip python3 && \
aws s3 cp s3://wsc-day2-artifacts-YOURID/stub1.zip /tmp/ && \
unzip -o /tmp/stub1.zip -d /opt/app && \
export TABLE_NAME=cloudraiser-iot PORT=8080 && \
python3 /opt/app/server.py"</pre>
                <div class="mini">ğŸ” ÙØ±Ø¶ Ø´Ø¯Ù‡ ÙØ§ÛŒÙ„ Ø²ÛŒÙ¾ Ø´Ø§Ù…Ù„ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª/Ø¨Ø§ÛŒÙ†Ø±ÛŒ ÙˆØ¨â€ŒØ³Ø±ÙˆØ± Ø§Ø³Øª (Ù…Ø«Ù„Ø§Ù‹ <code>server.py</code>) Ú©Ù‡ DDB Ù…ÛŒâ€ŒØ®ÙˆØ§Ù†Ø¯ Ùˆ Ø±ÙˆÛŒ Ù¾ÙˆØ±Øª 8080 Ø³Ø±Ùˆ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</div>
              </li>
              <li>Environment:
                <ul class="tight">
                  <li><code>TABLE_NAME = cloudraiser-iot</code></li>
                  <li><code>PORT = 8080</code></li>
                </ul>
              </li>
            </ul>
          </li>
          <li>Create</li>
        </ol>
      </div>

      <div class="step">
        <span class="num">2A-4</span><b>Ø³Ø§Ø®Øª ALB Ùˆ Target Group</b>
        <div class="mini">Ù…Ø³ÛŒØ±: <span class="path">EC2 â†’ Load Balancers â†’ Create â†’ Application Load Balancer</span></div>
        <ol>
          <li>Name: <code>wsc-alb</code>ØŒ Scheme: Internet-facingØŒ Subnets: Ù¾Ø§Ø¨Ù„ÛŒÚ© (a,b)</li>
          <li>Security Group: <b>SG-ALB</b> (ÙˆØ±ÙˆØ¯ÛŒ 80/443 Ø§Ø² Ø§ÛŒÙ†ØªØ±Ù†Øª)</li>
          <li>Target Group: <code>tg-ddbweb</code> (Ù†ÙˆØ¹: instance ÛŒØ§ IP) â€“ Health check:
            <ul class="tight">
              <li>Protocol: HTTPØŒ Path: <code>/health</code> (ÛŒØ§ <code>/</code> Ø§Ú¯Ø± Ø³Ù„Ø§Ù…Øª Ø®Ø§Øµ Ù†Ø¯Ø§Ø±ÛŒ)</li>
              <li>Port: <code>traffic-port</code> (8080)</li>
            </ul>
          </li>
          <li>Listener: HTTP:80 â†’ Forward Ø¨Ù‡ <code>tg-ddbweb</code></li>
        </ol>
      </div>

      <div class="step">
        <span class="num">2A-5</span><b>Ø§ÛŒØ¬Ø§Ø¯ Service Ø¯Ø± ECS Ùˆ Ø§ØªØµØ§Ù„ Ø¨Ù‡ ALB</b>
        <div class="mini">Ù…Ø³ÛŒØ±: <span class="path">ECS â†’ Clusters â†’ your-cluster â†’ Create â†’ Service</span></div>
        <ol>
          <li>Launch type: EC2ØŒ Task: <code>ddb-stub-web</code></li>
          <li>Desired tasks: 2ØŒ Subnets: Ø®ØµÙˆØµÛŒ (a,b)ØŒ SG: <b>SG-ECS-TASK</b></li>
          <li>Load balancing: Application â†’ Target group: <code>tg-ddbweb</code>ØŒ Port: 8080</li>
          <li>Auto scaling: Ø­Ø¯Ø§Ù‚Ù„ 2ØŒ Ø­Ø¯Ø§Ú©Ø«Ø± 4 (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</li>
          <li>Create Service</li>
        </ol>
      </div>

      <div class="step ok">
        <span class="num">2A-6</span><b>ØªØ³Øª ÙˆØ¨â€ŒØ³Ø±ÙˆÛŒØ³ DDB</b>
        <ol>
          <li>DNS ALB Ø±Ø§ Ø§Ø² Ø¬Ø²Ø¦ÛŒØ§Øª <code>wsc-alb</code> Ø¨Ø±Ø¯Ø§Ø± (Ù…Ø«Ù„: <code>wsc-alb-1234.us-east-1.elb.amazonaws.com</code>)</li>
          <li>Ù…Ø±ÙˆØ±Ú¯Ø±: <code>http://ALB-DNS/</code> ÛŒØ§ <code>/health</code></li>
          <li>CloudWatch Logs: <code>/wsc/day2/ecs/web</code> Ø±Ø§ Ú†Ú© Ú©Ù† (Ø®Ø·Ø§ÛŒ DDB/S3)</li>
        </ol>
      </div>

      <div class="callout">
        <b>Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø±Ø§ÛŒØ¬ Ùˆ Ø±ÙØ¹ Ø³Ø±ÛŒØ¹ (2A):</b>
        <ul class="tight">
          <li><b>Healthy=0%</b>: Ù…Ø³ÛŒØ± HealthCheck Ø±Ø§ Ø¯Ø±Ø³Øª Ú©Ù† (Ø§Ú¯Ø± Ø§Ù¾ Ù…Ø³ÛŒØ± Ù†Ø¯Ø§Ø±Ø¯ØŒ <code>/</code> Ø¨Ú¯Ø°Ø§Ø±)</li>
          <li><b>AccessDenied Ø¨Ù‡ S3/DDB</b>: Task Role Ø±Ø§ Ø¨Ø§ Policy Ø­Ø¯Ø§Ù‚Ù„ÛŒ Ø¨Ø§Ù„Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†</li>
          <li><b>Timeout</b>: SGÙ‡Ø§ Ø±Ø§ Ú†Ú© Ú©Ù† â€” ALB Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Ù¾ÙˆØ±Øª 8080 TaskÙ‡Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯</li>
        </ul>
      </div>
    </details>

    <!-- ========================= Stage 2B ========================= -->
    <details open>
      <summary>Stage 2B â€” Aurora (ØºÛŒØ± Serverless) + Ø³Ø±ÙˆÛŒØ³ GET Ø±ÙˆÛŒ ECS (API Ø¨Ø±Ø§ÛŒ val1..val10)</summary>

      <div class="step">
        <span class="num">2B-1</span><b>Ø§ÛŒØ¬Ø§Ø¯ Aurora PostgreSQL (ØºÛŒØ± Serverless)</b>
        <div class="mini">Ù…Ø³ÛŒØ±: <span class="path">RDS â†’ Create database â†’ Amazon Aurora</span></div>
        <ol>
          <li>Edition: <b>Aurora PostgreSQL-Compatible</b> (Provisioned)</li>
          <li>DB cluster identifier: <code>biz-aurora</code></li>
          <li>Master username/password Ø±Ø§ ØªØ¹ÛŒÛŒÙ† Ú©Ù† (ÛŒØ§ Secrets Manager)</li>
          <li>VPC: Ù‡Ù…Ø§Ù† <code>wsc-day2</code>ØŒ Subnets: Ø®ØµÙˆØµÛŒ (a,b)ØŒ Public access: No</li>
          <li>Security Group DB: <b>SG-DB</b> (ÙˆØ±ÙˆØ¯ÛŒ Port 5432 ÙÙ‚Ø· Ø§Ø² <b>SG-ECS-TASK</b>)</li>
          <li>Create</li>
        </ol>
      </div>

      <div class="step">
        <span class="num">2B-2</span><b>Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÙˆÙ„ Ø¨ÛŒØ²ÛŒÙ†Ø³</b>
        <div class="mini">Ù…Ø³ÛŒØ±: <span class="path">RDS â†’ Databases â†’ biz-aurora â†’ Query editor v2</span> ÛŒØ§ Ø¨Ø§ Ú©Ù„Ø§ÛŒÙ†Øª</div>
        <pre>CREATE TABLE IF NOT EXISTS t_values(
  id    varchar(64) PRIMARY KEY,
  val1  text, val2  text, val3  text, val4  text, val5  text,
  val6  text, val7  text, val8  text, val9  text, val10 text
);
INSERT INTO t_values(id,val1,val2) VALUES ('01','A','B')
ON CONFLICT (id) DO NOTHING;</pre>
      </div>

      <div class="step">
        <span class="num">2B-3</span><b>Ø³Ø±ÙˆÛŒØ³ API Ø±ÙˆÛŒ ECS (FastAPI) â€” ÙÙ‚Ø· Ú©Ù†Ø³ÙˆÙ„</b>
        <div class="mini">Ø§ÛŒØ¯Ù‡: ÛŒÚ© Ø§ÛŒÙ…ÛŒØ¬ Ø³Ø§Ø¯Ù‡ Ø¨Ø³Ø§Ø² Ú©Ù‡ Ø¨Ø§ <code>psycopg2-binary</code> Ø¨Ù‡ Aurora ÙˆØµÙ„ Ø´ÙˆØ¯ Ùˆ Ù…Ø³ÛŒØ± <code>/get_value?id=XX</code> Ø±Ø§ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯.</div>
        <ol>
          <li><b>ECR Ø±ÛŒÙ¾Ùˆ</b> Ø¨Ø³Ø§Ø²: <span class="path">ECR â†’ Create repository â†’ <code>biz-api</code></span></li>
          <li><b>Dockerfile</b> (Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ø®ÙˆØ¯Øª Ø¨Ø³Ø§Ø² Ùˆ Push Ú©Ù†):
            <pre># Dockerfile (python:3.12 on AL2023)
FROM public.ecr.aws/docker/library/python:3.12-alpine
RUN pip install --no-cache-dir fastapi uvicorn psycopg2-binary
WORKDIR /app
COPY app.py /app/app.py
ENV PORT=8081
CMD ["python","-m","uvicorn","app:app","--host","0.0.0.0","--port","8081"]</pre>
          </li>
          <li><b>app.py</b>:
            <pre>from fastapi import FastAPI, HTTPException
import os, psycopg2

app = FastAPI()
DB_HOST=os.getenv("DB_HOST"); DB_NAME=os.getenv("DB_NAME","postgres")
DB_USER=os.getenv("DB_USER"); DB_PASS=os.getenv("DB_PASS")
DB_PORT=os.getenv("DB_PORT","5432")

def fetch_row(id_):
    conn=psycopg2.connect(host=DB_HOST, dbname=DB_NAME, user=DB_USER, password=DB_PASS, port=DB_PORT, connect_timeout=3)
    try:
        with conn.cursor() as cur:
            cur.execute("SELECT id,val1,val2,val3,val4,val5,val6,val7,val8,val9,val10 FROM t_values WHERE id=%s", (id_,))
            r=cur.fetchone()
            if not r: return None
            keys=["id","val1","val2","val3","val4","val5","val6","val7","val8","val9","val10"]
            return dict(zip(keys, r))
    finally:
        conn.close()

@app.get("/health")
def health(): return {"ok":True}

@app.get("/get_value")
def get_value(id: str):
    row=fetch_row(id)
    if not row: raise HTTPException(404,"not found")
    return row</pre>
          </li>
          <li><b>Build & Push</b> (Ø±ÙˆÛŒ Ø³ÛŒØ³ØªÙ… Ø®ÙˆØ¯Øª):
            <pre># Login Ø¨Ù‡ ECR Ø§Ø² Ú©Ù†Ø³ÙˆÙ„ Ø¨Ù‡Øª Ø¯Ø³ØªÙˆØ± Ù…ÛŒØ¯Ù‡
docker build -t biz-api:latest .
docker tag biz-api:latest ACCOUNTID.dkr.ecr.us-east-1.amazonaws.com/biz-api:latest
docker push ACCOUNTID.dkr.ecr.us-east-1.amazonaws.com/biz-api:latest</pre>
          </li>
        </ol>
      </div>

      <div class="step">
        <span class="num">2B-4</span><b>Task Definition (EC2) Ø¨Ø±Ø§ÛŒ API</b>
        <div class="mini">Ù…Ø³ÛŒØ±: <span class="path">ECS â†’ Task definitions â†’ Create new â†’ EC2</span></div>
        <ol>
          <li>Family: <code>biz-api</code>, CPU/Memory: 256/512</li>
          <li>Task Role: <b>taskRole-bizapi</b> (Ù†ÛŒØ§Ø² Ø®Ø§ØµÛŒ Ø¬Ø² Logs Ù†Ø¯Ø§Ø±Ø¯)</li>
          <li>Execution Role: <code>ecsTaskExecutionRole</code></li>
          <li>Container:
            <ul class="tight">
              <li>Image: <code>â€¦/biz-api:latest</code></li>
              <li>Port: <code>8081</code></li>
              <li>Logs: <code>/wsc/day2/api</code></li>
              <li>Env (Plaintext ÛŒØ§ Ø§Ø² Secrets Manager):
                <ul class="tight">
                  <li><code>DB_HOST =</code> Ø¢Ø¯Ø±Ø³ Writer Ø§Ø² Ù¾Ù†Ù„ RDS (Endpoint)</li>
                  <li><code>DB_NAME = postgres</code> (ÛŒØ§ Ù†Ø§Ù…ÛŒ Ú©Ù‡ Ø³Ø§Ø®ØªÛŒ)</li>
                  <li><code>DB_USER, DB_PASS</code> (ØªØ±Ø¬ÛŒØ­Ø§Ù‹ Ø§Ø² Secrets Manager)</li>
                </ul>
              </li>
            </ul>
          </li>
          <li>Create</li>
        </ol>
      </div>

      <div class="step">
        <span class="num">2B-5</span><b>Service + Target Group + Rule Ø¯Ø± ALB</b>
        <ol>
          <li>Target Group Ø¯ÙˆÙ…: <code>tg-bizapi</code>ØŒ Health check: <code>/health</code>ØŒ Port: 8081</li>
          <li>Ø±ÙˆÛŒ ALB ÛŒÚ© Rule Ø¨Ø³Ø§Ø²:
            <ul class="tight">
              <li>Listener HTTP:80 â†’ Ø§Ú¯Ø± Path <code>/get_value*</code> â†’ Forward Ø¨Ù‡ <code>tg-bizapi</code></li>
              <li>Rule Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù‡Ù…Ú†Ù†Ø§Ù† Ø¨Ù‡ <code>tg-ddbweb</code> Ù…ÛŒâ€ŒØ±ÙˆØ¯ (ÙˆØ¨ Ø®Ø±ÙˆØ¬ÛŒ DDB)</li>
            </ul>
          </li>
          <li>Ø§ÛŒØ¬Ø§Ø¯ Service Ø¯Ø± ECS:
            <ul class="tight">
              <li>Cluster: Ù‚Ø¨Ù„ÛŒØŒ Task: <code>biz-api</code>, Desired: 2</li>
              <li>Subnets: Ø®ØµÙˆØµÛŒØŒ SG: <b>SG-ECS-TASK</b></li>
              <li>Load balancing: Application â†’ Target group: <code>tg-bizapi</code></li>
            </ul>
          </li>
        </ol>
      </div>

      <div class="step ok">
        <span class="num">2B-6</span><b>ØªØ³Øª API GET</b>
        <ol>
          <li>Ù…Ø±ÙˆØ±Ú¯Ø±/curl: <code>http://ALB-DNS/get_value?id=01</code></li>
          <li>Ø¨Ø§ÛŒØ¯ JSON Ø´Ø§Ù…Ù„ <code>val1..val10</code> Ø¨Ø±Ú¯Ø±Ø¯Ø¯</li>
          <li>Ø§Ú¯Ø± 404 Ú¯Ø±ÙØªÛŒØ¯: Ø¯ÛŒØªØ§ÛŒ Ø¬Ø¯ÙˆÙ„ Ø±Ø§ Ú†Ú© Ú©Ù†ÛŒØ¯ (Ù…Ø±Ø­Ù„Ù‡ 2B-2)</li>
        </ol>
      </div>

      <div class="callout">
        <b>Ù†Ú©Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ (Stage-2):</b>
        <ul class="tight">
          <li>SG-DB ÙÙ‚Ø· Ø§Ø² SG-ECS-TASK Ø§Ø¬Ø§Ø²Ù‡ Ø¨Ú¯ÛŒØ±Ø¯ (Ù†Ù‡ Ø§Ø² Ø§ÛŒÙ†ØªØ±Ù†Øª)</li>
          <li>Secrets Ø±Ø§ Ø¯Ø± Secrets Manager Ø¨Ú¯Ø°Ø§Ø± Ùˆ Ø¯Ø± Task Definition Ø¨Ù‡â€ŒØµÙˆØ±Øª <i>ValueFrom</i> ØªØ²Ø±ÛŒÙ‚ Ú©Ù†</li>
          <li>ALB Ø±Ø§ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¨Ø§ WAF Ù…Ø­Ø§ÙØ¸Øª Ú©Ù† (Stage-3)</li>
        </ul>
      </div>

      <div class="callout">
        <b>Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø±Ø§ÛŒØ¬ Ùˆ Ø±ÙØ¹ Ø³Ø±ÛŒØ¹ (2B):</b>
        <ul class="tight">
          <li><b>Connection refused Ø¨Ù‡ DB</b>: SGÙ‡Ø§/Port 5432 Ùˆ Endpoint Ø¯Ø±Ø³Øª Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†</li>
          <li><b>IAM Ù…Ø´Ú©Ù„ÛŒ Ù†Ø¯Ø§Ø±Ø¯ ÙˆÙ„ÛŒ Ø§Ù¾ 5xx Ù…ÛŒâ€ŒØ¯Ù‡Ø¯</b>: Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ <code>/wsc/day2/api</code> Ø±Ø§ Ø¨Ø§Ø²Ø¨ÛŒÙ†ÛŒ Ú©Ù† (Dependency psycopg2/Env)</li>
          <li><b>Rule ALB Ú©Ø§Ø± Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯</b>: ØªØ±ØªÛŒØ¨ RuleÙ‡Ø§ Ø±Ø§ Ú†Ú© Ú©Ù†Ø› Path Ø¨Ø§ÛŒØ¯ Ø¨Ø§ <code>/get_value</code> Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯</li>
        </ul>
      </div>
    </details>

    <!-- ========================= Stage 3 ========================= -->
    <details open>
      <summary>Stage 3 â€” Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ØŒ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒØŒ WAFØŒ Ops</summary>

      <div class="step">
        <span class="num">3-1</span><b>CloudWatch Dashboard (Ø³Ø±ÛŒØ¹)</b>
        <div class="mini">Ù…Ø³ÛŒØ±: <span class="path">CloudWatch â†’ Dashboards â†’ Create dashboard</span></div>
        <ul class="tight">
          <li>Kinesis: IncomingRecords/IteratorAge</li>
          <li>Lambda: Errors/Duration Ø¨Ø±Ø§ÛŒ <code>kda-ddb-sink</code></li>
          <li>DynamoDB: ThrottledRequests</li>
          <li>ALB: 4xx/5xx, TargetResponseTime</li>
          <li>ECS ServiceÙ‡Ø§: CPU/MemoryUtilization</li>
          <li>RDS: CPU, FreeableMemory, DBConnections, CommitLatency</li>
        </ul>
      </div>

      <div class="step">
        <span class="num">3-2</span><b>CloudWatch Alarms (Ø­Ø¯Ø§Ù‚Ù„â€ŒÙ‡Ø§)</b>
        <ul class="tight">
          <li>KDA/Lambda Errors > 0 Ø¨Ø±Ø§ÛŒ 5 Ø¯Ù‚ÛŒÙ‚Ù‡ â†’ SNS Ø§Ø¹Ù„Ø§Ù†</li>
          <li>ALB 5xx > 1% Ø¨Ø±Ø§ÛŒ 5 Ø¯Ù‚ÛŒÙ‚Ù‡ â†’ SNS</li>
          <li>RDS FreeStorageSpace Ù¾Ø§ÛŒÛŒÙ† â†’ SNS</li>
        </ul>
      </div>

      <div class="step">
        <span class="num">3-3</span><b>WAF Ø±ÙˆÛŒ ALB (ÛŒØ§ API)</b>
        <div class="mini">Ù…Ø³ÛŒØ±: <span class="path">WAF & Shield â†’ Web ACLs â†’ Create</span></div>
        <ol>
          <li>Region: us-east-1ØŒ Name: <code>wsc-web-acl</code></li>
          <li>Add rules â†’ <b>AWS Managed Rule groups</b>:
            <ul class="tight">
              <li>Core rule set (CRS)</li>
              <li>SQLi, NoSQLi, CommonRule</li>
              <li>Bot Control (Ø§Ú¯Ø± Ù…Ø¬Ø§Ø² Ø¨ÙˆØ¯)</li>
            </ul>
          </li>
          <li>Default action: Allow</li>
          <li>Resources: ALB <code>wsc-alb</code> Ø±Ø§ Associate Ú©Ù†</li>
        </ol>
      </div>

      <div class="step">
        <span class="num">3-4</span><b>Cost/Scale</b>
        <ul class="tight">
          <li>Kinesis/DDB Ø±ÙˆÛŒ On-demand Ø§ÙˆÚ©ÛŒØŒ ÙˆÙ„ÛŒ Ø¨Ø§ Ø±Ø´Ø¯ ØªØ±Ø§ÙÛŒÚ© Auto Scaling ECS Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†</li>
          <li>Log Retention Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù† (Û· ÛŒØ§ Û±Û´ Ø±ÙˆØ²)</li>
          <li>S3 Lifecycle Ø¨Ø±Ø§ÛŒ artifacts/logs ÙØ¹Ø§Ù„ Ú©Ù†</li>
        </ul>
      </div>

      <div class="step">
        <span class="num">3-5</span><b>Ops (Ø¨ÛŒÙ„Ø¯/Ø¯ÛŒÙ¾Ù„ÙˆÛŒ)</b>
        <ul class="tight">
          <li>Ø¨Ø±Ø§ÛŒ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ ECS: CodePipeline (Source: ECRØŒ Deploy: CodeDeploy/Blue-Green)</li>
          <li>Ø¨Ø±Ø§ÛŒ Ø¨Ø§ÛŒÙ†Ø±ÛŒ Ø±Ø³Ù…ÛŒ: ÙÙ‚Ø· Ø¨Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ/Ø§Ø¬Ø±Ø§ â€” ØªØºÛŒÛŒØ± Ù…Ø­ØªÙˆØ§ Ù…Ù…Ù†ÙˆØ¹</li>
        </ul>
      </div>
    </details>

    <!-- ========================= Cleanup ========================= -->
    <details>
      <summary>Cleanup â€” Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù‡Ø²ÛŒÙ†Ù‡</summary>
      <div class="step">
        <span class="num">C</span>
        <ul class="tight">
          <li>Stop/Delete: KDA App, Kinesis Streams</li>
          <li>Delete Services/Tasks/Autoscaling/ALB</li>
          <li>Delete DynamoDB table (Ø¯Ø± ØµÙˆØ±Øª ØªÙ…Ø±ÛŒÙ†ÛŒ)</li>
          <li>Delete RDS/Aurora (final snapshot Ø§Ú¯Ø± Ù„Ø§Ø²Ù… Ø§Ø³Øª)</li>
          <li>Delete Redshift cluster (snapshot Ø§Ú¯Ø± Ù„Ø§Ø²Ù… Ø§Ø³Øª)</li>
          <li>Ø­Ø°Ù Log groupÙ‡Ø§ÛŒ ØºÛŒØ±Ø¶Ø±ÙˆØ±ÛŒ</li>
        </ul>
      </div>
    </details>

  </div>
</body>
</html>
