<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Lambda DynamoDB</h1>


     <details class="note" style="padding: 20px !important;">
        <summary>
            lambda + dunamo ==> CRUD
        </summary>
        <ul class="steps">
        <li>
           <div class="code-box"><code class="copyable">
import json
import boto3
import decimal
from boto3.dynamodb.conditions import Key, Attr
from botocore.exceptions import ClientError

# âœ… Ù‡Ù†Ø¯Ù„ Ú©Ø±Ø¯Ù† Decimal
class DecimalEncoder(json.JSONEncoder):
    def default(self, o):
        if isinstance(o, decimal.Decimal):
            if o % 1 == 0:
                return int(o)
            return float(o)
        return super(DecimalEncoder, self).default(o)


def lambda_handler(event, context):
    table_name = "users"  # ğŸ‘ˆ Ø§Ø³Ù… Ø¬Ø¯ÙˆÙ„ DynamoDB
    partition_key = "id"

    dynamodb = boto3.resource("dynamodb")
    table = dynamodb.Table(table_name)

    method = event.get("httpMethod", "")
    params = event.get("queryStringParameters") or {}

    try:
        # =============================
        # ğŸ”¹ GET â†’ Ú¯Ø±ÙØªÙ† Ø¯Ø§Ø¯Ù‡
        # =============================
        if method == "GET":
            key_value = params.get("id")
            username = params.get("username")

            if key_value:
                key_value = decimal.Decimal(key_value)
                response = table.query(
                    KeyConditionExpression=Key(partition_key).eq(key_value)
                )
                items = response.get("Items", [])

            elif username:
                response = table.scan(
                    FilterExpression=Attr("username").eq(username)
                )
                items = response.get("Items", [])

            else:
                response = table.scan()
                items = response.get("Items", [])

            return {
                "statusCode": 200,
                "headers": {"Content-Type": "application/json"},
                "body": json.dumps(items, cls=DecimalEncoder)
            }

        # =============================
        # ğŸ”¹ POST â†’ Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ø§Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯
        # =============================
        elif method == "POST":
            body = json.loads(event.get("body") or "{}")
            id_value = body.get("id")
            username = body.get("username")

            if not id_value or not username:
                return {
                    "statusCode": 400,
                    "headers": {"Content-Type": "application/json"},
                    "body": json.dumps({"error": "Both 'id' and 'username' are required"})
                }

            table.put_item(Item={"id": decimal.Decimal(str(id_value)), "username": username})

            return {
                "statusCode": 201,
                "headers": {"Content-Type": "application/json"},
                "body": json.dumps({"message": "User added successfully"})
            }

        # =============================
        # ğŸ”¹ PUT â†’ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ id Ùˆ username
        # =============================
        elif method == "PUT":
            body = json.loads(event.get("body") or "{}")
            id_value = body.get("id")
            username = body.get("username")
            email = body.get("email")

            if not id_value or not username or not email:
                return {
                    "statusCode": 400,
                    "headers": {"Content-Type": "application/json"},
                    "body": json.dumps({"error": "Fields 'id', 'username', and 'email' are required"})
                }

            id_value = decimal.Decimal(id_value)

            table.update_item(
                Key={"id": id_value, "username": username},
                UpdateExpression="SET email = :email",
                ExpressionAttributeValues={":email": email}
            )

            return {
                "statusCode": 200,
                "headers": {"Content-Type": "application/json"},
                "body": json.dumps({"message": "User updated successfully"})
            }

        # =============================
        # ğŸ”¹ DELETE â†’ Ø­Ø°Ù Ø¯Ø§Ø¯Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ id Ùˆ username
        # =============================
        elif method == "DELETE":
            key_value = params.get("id")
            username = params.get("username")

            if not key_value or not username:
                return {
                    "statusCode": 400,
                    "headers": {"Content-Type": "application/json"},
                    "body": json.dumps({"error": "Both 'id' and 'username' query parameters are required"})
                }

            key_value = decimal.Decimal(key_value)

            table.delete_item(Key={"id": key_value, "username": username})

            return {
                "statusCode": 200,
                "headers": {"Content-Type": "application/json"},
                "body": json.dumps({"message": f"User with id={key_value} and username={username} deleted successfully"})
            }

        # =============================
        # âŒ Ø³Ø§ÛŒØ± Ù…ØªØ¯Ù‡Ø§
        # =============================
        else:
            return {
                "statusCode": 405,
                "headers": {"Content-Type": "application/json"},
                "body": json.dumps({"error": f"Method {method} not allowed"})
            }

    except ClientError as e:
        return {
            "statusCode": 500,
            "headers": {"Content-Type": "application/json"},
            "body": json.dumps({"error": str(e)})
        }

    except Exception as e:
        return {
            "statusCode": 500,
            "headers": {"Content-Type": "application/json"},
            "body": json.dumps({"error": str(e)})
        }


           </code></div>
        </li>
        <li>
             <div class="code-box"><code>

  curl -X GET "https://sac4wm2ohj.execute-api.us-east-1.amazonaws.com/dev/user"

  ============================

  curl -X POST "https://sac4wm2ohj.execute-api.us-east-1.amazonaws.com/dev/user" \
  -H "Content-Type: application/json" \
  -d '{"id": 7, "username": "reza"}'

  ============================

 curl -X PUT "https://sac4wm2ohj.execute-api.us-east-1.amazonaws.com/dev/update" \
  -H "Content-Type: application/json" \
  -d '{"id": 5, "username": "farhad", "email": "testemail@gmail.com"}'


  ============================

  curl -X DELETE "https://sac4wm2ohj.execute-api.us-east-1.amazonaws.com/dev/user?id=7&username=rza"

             </code>
        </li>
        <li dir="rtl" style="color: red !important;">
            ğŸ”¹ Ø±Ø§Ù‡ 1: Ø±ÙˆØ´ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ (Delete + Put)

Ú†ÙˆÙ† Ù†Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ú©Ù„ÛŒØ¯ Ø±Ùˆ ØªØºÛŒÛŒØ± Ø¨Ø¯ÛŒØŒ Ø¨Ø§ÛŒØ¯ Ø±Ú©ÙˆØ±Ø¯ Ù‚Ø¯ÛŒÙ…ÛŒ Ø±Ùˆ Ø­Ø°Ù Ùˆ Ø±Ú©ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯ Ø±Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒ:
        </li>
            <li>
             <div class="code-box"><code class="copyable">

elif method == "PUT":
    body = json.loads(event.get("body") or "{}")
    id_value = body.get("id")
    username = body.get("username")
    new_username = body.get("new_username")

    if not id_value or not username or not new_username:
        return {
            "statusCode": 400,
            "headers": {"Content-Type": "application/json"},
            "body": json.dumps({"error": "id, username and new_username are required"})
        }

    id_value = decimal.Decimal(str(id_value))

    # Ø­Ø°Ù Ø±Ú©ÙˆØ±Ø¯ Ù‚Ø¨Ù„ÛŒ
    table.delete_item(Key={"id": id_value, "username": username})

    # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø±Ú©ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯
    table.put_item(Item={"id": id_value, "username": new_username})

    return {
        "statusCode": 200,
        "headers": {"Content-Type": "application/json"},
        "body": json.dumps({"message": f"Username updated from {username} to {new_username}"})
    }


             </code>
        </li>
        </ul>
    </details>



    <details class="note" style="padding: 20px !important;">
        <summary>
            Lambda + DynamoDB + API Gateway (get version 2)
        </summary>
        <ul class="steps">
        <li>
           <div class="code-box"><code class="copyable">

import json
import boto3
import decimal
from boto3.dynamodb.conditions import Key, Attr
from botocore.exceptions import ClientError

# âœ… Ø¨Ø±Ø§ÛŒ Ù‡Ù†Ø¯Ù„ Ú©Ø±Ø¯Ù† Decimal Ø§Ø² DynamoDB
class DecimalEncoder(json.JSONEncoder):
    def default(self, o):
        if isinstance(o, decimal.Decimal):
            if o % 1 == 0:
                return int(o)
            return float(o)
        return super(DecimalEncoder, self).default(o)


def lambda_handler(event, context):
    table_name = "users"   # ğŸ‘ˆ Ø§Ø³Ù… Ø¯Ù‚ÛŒÙ‚ Ø¬Ø¯ÙˆÙ„Øª Ø±Ùˆ Ù…Ø·Ù…Ø¦Ù† Ø´Ùˆ
    partition_key = "id"

    params = event.get("queryStringParameters") or {}
    key_value = params.get("id")
    username = params.get("username")

    dynamodb = boto3.resource("dynamodb")
    table = dynamodb.Table(table_name)

    try:
        # âœ… Ø§Ú¯Ø± id Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ â†’ Query
        if key_value:
            try:
                key_value = decimal.Decimal(key_value)
            except Exception:
                return {
                    "statusCode": 400,
                    "headers": {"Content-Type": "application/json"},
                    "body": json.dumps({"error": "Invalid id type, expected a number"})
                }

            response = table.query(
                KeyConditionExpression=Key(partition_key).eq(key_value)
            )
            items = response.get("Items", [])

        # âœ… Ø§Ú¯Ø± ÙÙ‚Ø· username Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ â†’ Scan Ø¨Ø§ ÙÛŒÙ„ØªØ±
        elif username:
            response = table.scan(
                FilterExpression=Attr("username").eq(username)
            )
            items = response.get("Items", [])

        # âœ… Ø§Ú¯Ø± Ù‡ÛŒÚ† Ù¾Ø§Ø±Ø§Ù…ØªØ±ÛŒ Ù†ÛŒØ³Øª â†’ Ú©Ù„ Ø¬Ø¯ÙˆÙ„
        else:
            response = table.scan()
            items = response.get("Items", [])

        return {
            "statusCode": 200,
            "headers": {"Content-Type": "application/json"},
            "body": json.dumps(items, cls=DecimalEncoder)
        }

    except ClientError as e:
        return {
            "statusCode": 500,
            "headers": {"Content-Type": "application/json"},
            "body": json.dumps({"error": str(e)})
        }

    except Exception as e:
        return {
            "statusCode": 500,
            "headers": {"Content-Type": "application/json"},
            "body": json.dumps({"error": str(e)})
        }


           </code></div>
        </li>
        </ul>
    </details>

       <details class="note" style="padding: 20px !important;">
    <summary>DynamoDB Lambda => GET (API GATEWAY)</summary>
      
  <ul class="steps">
        <div class="code-box"><code class="copyable">  
# filename: lambda_function.py
import os
import json
import boto3

dynamodb = boto3.resource("dynamodb")
TABLE_NAME = os.getenv("TABLE_NAME", "Messages")
table = dynamodb.Table(TABLE_NAME)

CORS_HEADERS = {
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "GET,OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type,Authorization"
}

def _ok(body_dict, status=200):
    return {
        "statusCode": status,
        "headers": {"Content-Type": "application/json", **CORS_HEADERS},
        "body": json.dumps(body_dict)  # Ù…Ù‡Ù…: Ø¨Ø§ÛŒØ¯ Ø§Ø³ØªØ±ÛŒÙ†Ú¯ Ø¨Ø§Ø´Ù‡
    }

def _error(msg, status=400):
    return _ok({"error": msg}, status=status)

def _extract_id(event):
    """
    Ø§Ø² Ø³Ù‡ Ø¬Ø§ Ø³Ø¹ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… id Ø±Ùˆ Ø¨Ú¯ÛŒØ±ÛŒÙ…:
    1) Ù…Ø³ÛŒØ±: /messages/{id}  => pathParameters
    2) Ú©ÙˆØ¦Ø±ÛŒ: ?id=123        => queryStringParameters
    3) Ø¨Ø§Ø¯ÛŒ JSON: {"id":"..."} (Ø¨Ø±Ø§ÛŒ POST/PUT)
    4) Invoke Ù…Ø³ØªÙ‚ÛŒÙ…: {"id":"..."} (Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ)
    """
    # v2.0 (HTTP API) ÛŒØ§ v1.0 (REST) ÛŒØ§ invoke Ù…Ø³ØªÙ‚ÛŒÙ…
    # 1) path
    path_params = event.get("pathParameters") or {}
    if isinstance(path_params, dict):
        if "id" in path_params and path_params["id"]:
            return path_params["id"]

    # 2) query
    qs = event.get("queryStringParameters") or {}
    if isinstance(qs, dict):
        if "id" in qs and qs["id"]:
            return qs["id"]

    # 3) body JSON
    body = event.get("body")
    if body:
        try:
            # Ø¯Ø± v2 Ù…Ù…Ú©Ù†Ù‡ base64 Ø¨Ø§Ø´Ù‡ØŒ ÙˆÙ„ÛŒ Ø¨Ø±Ø§ÛŒ JSON Ù…Ø¹Ù…ÙˆÙ„ÛŒ Ù‡Ù…ÛŒÙ† Ú©Ø§ÙÛŒÙ‡.
            data = json.loads(body) if isinstance(body, str) else body
            if isinstance(data, dict) and data.get("id"):
                return data["id"]
        except Exception:
            pass

    # 4) invoke Ù…Ø³ØªÙ‚ÛŒÙ…
    if isinstance(event, dict) and event.get("id"):
        return event["id"]

    return None

def lambda_handler(event, context):
    # preflight CORS
    if event.get("requestContext", {}).get("http", {}).get("method") == "OPTIONS":
        return {
            "statusCode": 204,
            "headers": CORS_HEADERS,
            "body": ""
        }

    item_id = _extract_id(event)
    if not item_id:
        return _error("Ù„Ø·ÙØ§Ù‹ Ù¾Ø§Ø±Ø§Ù…ØªØ± id Ø±Ø§ Ø¨Ø¯Ù‡ÛŒØ¯ (path/query/body).", 400)

    try:
        resp = table.get_item(Key={"id": item_id})
    except Exception as e:
        return _error(f"Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† DynamoDB: {str(e)}", 500)

    item = resp.get("Item")
    if not item:
        return _error(f"Ø¢ÛŒØªÙ… Ø¨Ø§ id={item_id} Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.", 404)

    return _ok(item, 200)
        </code></div>
        <li dir="rtl" style="color: red !important;">ØªØ³Øª Ø³Ø±ÛŒØ¹</li>
        <li>
             <div class="code-box"><code>
                ) Ø¨Ø§ Ù…Ø³ÛŒØ± (Path Parameter)
                curl -i "https://[your-api-id].execute-api.[region].amazonaws.com/messages/123"
                
                    ====================================================

                ) Ø¨Ø§ Ú©ÙˆØ¦Ø±ÛŒ
                curl -i "https://[your-api-id].execute-api.[region].amazonaws.com/messages?id=123"

                    ====================================================

                ) Ø¨Ø§ Ø¨Ø§Ø¯ÛŒ JSON  
                curl -i -X POST "https://[your-api-id].execute-api.[region].amazonaws.com/messages" \
                -H "Content-Type: application/json" \
                -d '{"id":"123"}'
             </code></div>
        </li>
  </ul>
</details>


    <details class="note" style="padding: 20px !important;">
    <summary>Lambda â†’ DynamoDB GetItem</summary>
      
  <ul class="steps">
        <div class="code-box"><code class="copyable">
# filename: lambda_function.py

import os
import boto3
from boto3.dynamodb.conditions import Key

# Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆÛŒØ³ DynamoDB
dynamodb = boto3.resource("dynamodb")

# Ú¯Ø±ÙØªÙ† Ù†Ø§Ù… Ø¬Ø¯ÙˆÙ„ Ø§Ø² Environment Variable (Ø¨Ù‡ØªØ± Ø§Ø² Ù‡Ø§Ø±Ø¯Ú©Ø¯ Ú©Ø±Ø¯Ù†)
TABLE_NAME = os.getenv("TABLE_NAME", "Messages")
table = dynamodb.Table(TABLE_NAME)

def lambda_handler(event, context):
    """
    Ø§ÛŒÙ† ÙØ§Ù†Ú©Ø´Ù† ÙˆÙ‚ØªÛŒ Ø§Ø¬Ø±Ø§ Ù…ÛŒØ´Ù‡ØŒ ÛŒÚ© Ù…Ù‚Ø¯Ø§Ø± Ø±Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ id Ø§Ø² DynamoDB Ù…ÛŒâ€ŒØ®ÙˆÙ†Ù‡.
    event Ø¨Ø§ÛŒØ¯ Ø´Ø§Ù…Ù„ "id" Ø¨Ø§Ø´Ù‡.
    """

    # 1) Ú¯Ø±ÙØªÙ† id Ø§Ø² ÙˆØ±ÙˆØ¯ÛŒ event
    item_id = event.get("id")   # Ù…Ø«Ù„Ø§ {"id": "1234"}
    if not item_id:
        return {
            "statusCode": 400,
            "body": "âŒ Ù„Ø·ÙØ§Ù‹ ÛŒÚ© id Ø¨Ø¯Ù‡ÛŒØ¯"
        }

    # 2) ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ DynamoDB Ø¨Ø±Ø§ÛŒ Ú¯Ø±ÙØªÙ† Ø¯Ø§Ø¯Ù‡
    try:
        response = table.get_item(Key={"id": item_id})
    except Exception as e:
        return {
            "statusCode": 500,
            "body": f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† DynamoDB: {str(e)}"
        }

    # 3) Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¯Ø§Ø¯Ù‡ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´Øª ÛŒØ§ Ù†Ù‡
    item = response.get("Item")
    if not item:
        return {
            "statusCode": 404,
            "body": f"âŒ Ø¢ÛŒØªÙ… Ø¨Ø§ id={item_id} Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯"
        }

    # 4) Ø¨Ø±Ú¯Ø±Ø¯ÙˆÙ†Ø¯Ù† Ø¢ÛŒØªÙ…
    return {
        "statusCode": 200,
        "body": item
    }

        </code></div>
  </ul>
</details>

   <details class="note" style="padding: 20px !important;">
    <summary>Lambda â†’ DynamoDB PutItem</summary>
      
  <ul class="steps">
        <div class="code-box"><code class="copyable">
            # filename: lambda_function.py

import os
import json
import uuid
import boto3
from decimal import Decimal

# Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆÛŒØ³ DynamoDB
dynamodb = boto3.resource("dynamodb")

# Ú¯Ø±ÙØªÙ† Ù†Ø§Ù… Ø¬Ø¯ÙˆÙ„ Ø§Ø² Environment Variable
TABLE_NAME = os.getenv("TABLE_NAME", "Messages")
table = dynamodb.Table(TABLE_NAME)

def lambda_handler(event, context):
    """
    Ø§ÛŒÙ† ÙØ§Ù†Ú©Ø´Ù† ÛŒÚ© Ø¢ÛŒØªÙ… Ø¬Ø¯ÛŒØ¯ ØªÙˆÛŒ DynamoDB Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ù‡.
    ÙˆØ±ÙˆØ¯ÛŒ event Ø¨Ø§ÛŒØ¯ Ø´Ø§Ù…Ù„ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¯Ø§Ø¯Ù‡ Ø¨Ø§Ø´Ù‡ (Ù…Ø«Ù„Ø§ message ÛŒØ§ sentiment).
    """

    # 1) Ú¯Ø±ÙØªÙ† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² event
    message = event.get("message", "no-message")
    sentiment = event.get("sentiment", "UNKNOWN")
    score = event.get("score", 0.0)

    # 2) Ø³Ø§Ø®Øª id ÛŒÚ©ØªØ§ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¢ÛŒØªÙ…
    item_id = str(uuid.uuid4())

    # 3) Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¢ÛŒØªÙ… Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡
    item = {
        "id": item_id,                       # Ú©Ù„ÛŒØ¯ Ø§ØµÙ„ÛŒ Ø¬Ø¯ÙˆÙ„
        "message": message,                  # Ù…ØªÙ† Ù¾ÛŒØ§Ù…
        "sentiment": sentiment,              # Ø§Ø­Ø³Ø§Ø³
        "score": Decimal(str(score)),        # Ø¹Ø¯Ø¯ (float Ø¨Ø§ÛŒØ¯ Ø¨Ù‡ Decimal ØªØ¨Ø¯ÛŒÙ„ Ø´Ù‡)
    }

    # 4) Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± DynamoDB
    try:
        table.put_item(Item=item)
    except Exception as e:
        return {
            "statusCode": 500,
            "body": f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†ÙˆØ´ØªÙ† DynamoDB: {str(e)}"
        }

    # 5) Ø®Ø±ÙˆØ¬ÛŒ Ù…ÙˆÙÙ‚
    return {
        "statusCode": 200,
        "body": json.dumps({
            "msg": "âœ… Ø¢ÛŒØªÙ… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯",
            "id": item_id,
            "item": item
        }, ensure_ascii=False)   # ensure_ascii=False Ø¨Ø±Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ
    }
        </code></div>
  </ul>
</details>

</details>

   <details class="note" style="padding: 20px !important;">
    <summary dir="rtl">GetItem â€” Ø®ÙˆØ§Ù†Ø¯Ù† ÛŒÚ© Ø±Ú©ÙˆØ±Ø¯ Ø¨Ø§ Ú©Ù„ÛŒØ¯ Ø§ØµÙ„ÛŒ</summary>
      
  <ul class="steps">
        <div class="code-box"><code class="copyable">
# filename: lambda_function.py
import os
import json
import boto3

# Ø³Ø§Ø®Øª Ú©Ù„Ø§ÛŒÙ†Øª/Ù…Ù†Ø¨Ø¹ DynamoDB
dynamodb = boto3.resource("dynamodb")
# Ù†Ø§Ù… Ø¬Ø¯ÙˆÙ„ Ø±Ø§ Ø§Ø² Env Ø¨Ú¯ÛŒØ± (Ø¨Ù‡ØªØ± Ø§Ø² Ù‡Ø§Ø±Ø¯Ú©Ø¯)
TABLE = os.getenv("TABLE", "Items")
table = dynamodb.Table(TABLE)

def lambda_handler(event, context):
    # â† Ø§Ù†ØªØ¸Ø§Ø±: event Ù…Ø«Ù„ {"id": "123"}
    item_id = event.get("id")  # Ú©Ù„ÛŒØ¯ Ù¾Ø§Ø±ØªÛŒØ´Ù† ÙØ±Ø¶Ø§Ù‹ "id" Ø§Ø³Øª
    if not item_id:
        # Ø§Ú¯Ø± id Ù†Ø¯Ø§Ø¯Ù†Ø¯ØŒ Ø®Ø·Ø§ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†
        return {"statusCode": 400, "body": json.dumps({"error": "id is required"})}

    try:
        # GetItem Ø¨Ø§ Ú©Ù„ÛŒØ¯ Ø§ØµÙ„ÛŒ
        resp = table.get_item(Key={"id": item_id})
        item = resp.get("Item")
        if not item:
            # Ø§Ú¯Ø± Ø¢ÛŒØªÙ… Ù†Ø¨ÙˆØ¯
            return {"statusCode": 404, "body": json.dumps({"error": "not found"})}
        # Ù…ÙˆÙÙ‚: Ø¢ÛŒØªÙ… Ø±Ø§ Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†
        return {"statusCode": 200, "body": json.dumps(item, ensure_ascii=False)}
    except Exception as e:
        # Ù‡Ù†Ø¯Ù„ Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡
        return {"statusCode": 500, "body": json.dumps({"error": str(e)})}

        </code></div>
  </ul>
</details>

</details>

   <details class="note" style="padding: 20px !important;">
    <summary dir="rtl">PutItem â€” Ø¯Ø±Ø¬ Ø±Ú©ÙˆØ±Ø¯ Ø¨Ø§ Ø´Ø±Ø· Idempotent (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´Øª Ù†Ø±ÛŒØ²)</summary>
      
  <ul class="steps">
        <div class="code-box"><code class="copyable"> 
# filename: lambda_function.py
import os, json, uuid, boto3
from decimal import Decimal

dynamodb = boto3.resource("dynamodb")
TABLE = os.getenv("TABLE", "Items")
table = dynamodb.Table(TABLE)

def lambda_handler(event, context):
    # Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ (Ø¯Ù„Ø®ÙˆØ§Ù‡)Ø› Ø§Ú¯Ø± Ù†Ø¨ÙˆØ¯ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±ÛŒÙ…
    message = event.get("message", "no-message")
    score = Decimal(str(event.get("score", 0)))

    # ØªÙˆÙ„ÛŒØ¯ id ÛŒÚ©ØªØ§
    item_id = event.get("id") or str(uuid.uuid4())

    try:
        # Ø´Ø±Ø·: Ø§Ú¯Ø± id Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø±Ø¬ Ù†Ø¯Ù‡
        table.put_item(
            Item={"id": item_id, "message": message, "score": score},
            ConditionExpression="attribute_not_exists(id)"
        )
        return {"statusCode": 200, "body": json.dumps({"ok": True, "id": item_id})}
    except Exception as e:
        # Ø§Ú¯Ø± Ø´Ø±Ø· Ù†Ù‚Ø¶ Ø´ÙˆØ¯ØŒ ConditionalCheckFailedException Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒÙ…
        return {"statusCode": 409, "body": json.dumps({"ok": False, "error": str(e)})}
  
        </code></div>
  </ul>
</details>

</details>

   <details class="note" style="padding: 20px !important;">
    <summary dir="rtl">UpdateItem â€” Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨Ø§ UpdateExpression (SET/ADD/REMOVE)</summary>
      
  <ul class="steps">
        <div class="code-box"><code class="copyable">   
            # filename: lambda_function.py
import os, json, boto3
from decimal import Decimal

dynamodb = boto3.resource("dynamodb")
TABLE = os.getenv("TABLE", "Items")
table = dynamodb.Table(TABLE)

def lambda_handler(event, context):
    # Ø§Ù†ØªØ¸Ø§Ø±: {"id":"123", "message":"new text", "inc": 1, "removeField": true}
    item_id = event["id"]                 # Ø´Ù†Ø§Ø³Ù‡ Ø±Ú©ÙˆØ±Ø¯
    new_message = event.get("message")    # Ù…Ù‚Ø¯Ø§Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„Ø¯ message
    inc = Decimal(str(event.get("inc", 0)))  # Ù…ÛŒØ²Ø§Ù†ÛŒ Ú©Ù‡ Ø¨Ù‡ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯
    remove_field = event.get("removeField", False)  # Ø§Ú¯Ø± TrueØŒ ÛŒÚ© ÙÛŒÙ„Ø¯ Ø±Ø§ Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…

    # Ø³Ø§Ø®Øª UpdateExpression Ø¯Ø§ÛŒÙ†Ø§Ù…ÛŒÚ©
    expr = []
    names = {}
    values = {}

    if new_message is not None:
        # SET #m = :m
        expr.append("SET #m = :m")
        names["#m"] = "message"
        values[":m"] = new_message

    if inc != 0:
        # ADD #c :one  (Ø§ÙØ²Ø§ÛŒØ´ Ø§ØªÙ…ÛŒÚ© Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡)
        expr.append("ADD #c :one")
        names["#c"] = "count"
        values[":one"] = inc

    if remove_field:
        # REMOVE #tmp
        expr.append("REMOVE #tmp")
        names["#tmp"] = "tempField"

    # Ø§Ú¯Ø± Ù‡ÛŒÚ† Ø¹Ù…Ù„ÛŒØ§ØªÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯
    if not expr:
        return {"statusCode": 400, "body": json.dumps({"error":"no update ops"})}

    try:
        # Ø§Ø¹Ù…Ø§Ù„ Ø¢Ù¾Ø¯ÛŒØª Ùˆ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§Ø²Ú¯Ø´Øª Ù…Ù‚Ø¯Ø§Ø± Ø¬Ø¯ÛŒØ¯
        resp = table.update_item(
            Key={"id": item_id},
            UpdateExpression=" ".join(expr),
            ExpressionAttributeNames=names or None,
            ExpressionAttributeValues=values or None,
            ReturnValues="ALL_NEW"
        )
        return {"statusCode": 200, "body": json.dumps(resp.get("Attributes", {}), ensure_ascii=False)}
    except Exception as e:
        return {"statusCode": 500, "body": json.dumps({"error": str(e)})}

        </code></div>
  </ul>
</details>

</details>

   <details class="note" style="padding: 20px !important;">
    <summary dir="rtl">Optimistic Locking â€” Ø¢Ù¾Ø¯ÛŒØª Ù…Ø´Ø±ÙˆØ· Ø¨Ø§ ÙÛŒÙ„Ø¯ version</summary>
      
  <ul class="steps">
        <div class="code-box"><code class="copyable">   
            # filename: lambda_function.py
import os, json, boto3
from decimal import Decimal

dynamodb = boto3.resource("dynamodb")
TABLE = os.getenv("TABLE", "Items")
table = dynamodb.Table(TABLE)

def lambda_handler(event, context):
    # Ø§Ù†ØªØ¸Ø§Ø±: {"id":"123", "expectedVersion": 3, "message": "new"}
    item_id = event["id"]
    expected_version = Decimal(str(event["expectedVersion"]))  # Ù†Ø³Ø®Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø§Ø±ÛŒÙ…
    new_message = event.get("message", "")

    try:
        # ÙÙ‚Ø· Ø§Ú¯Ø± version ÙØ¹Ù„ÛŒ == expectedVersion Ø¢Ù¾Ø¯ÛŒØª Ú©Ù† Ùˆ version++ Ú©Ù†
        resp = table.update_item(
            Key={"id": item_id},
            UpdateExpression="SET #m = :m, #v = #v + :one",
            ConditionExpression="#v = :ev",
            ExpressionAttributeNames={"#m": "message", "#v": "version"},
            ExpressionAttributeValues={":m": new_message, ":ev": expected_version, ":one": Decimal("1")},
            ReturnValues="ALL_NEW"
        )
        return {"statusCode": 200, "body": json.dumps(resp["Attributes"], ensure_ascii=False)}
    except Exception as e:
        # Ø§Ú¯Ø± Ù†Ø³Ø®Ù‡ Ù†Ø®ÙˆØ§Ù†Ø¯ØŒ ConditionalCheckFailedException
        return {"statusCode": 409, "body": json.dumps({"error": str(e)})}

        </code></div>
  </ul>
</details>

</details>

   <details class="note" style="padding: 20px !important;">
    <summary dir="rtl">DeleteItem â€” Ø­Ø°Ù Ù…Ø´Ø±ÙˆØ· (Ù…Ø«Ù„Ø§Ù‹ ÙÙ‚Ø· Ø§Ú¯Ø± owner Ø¨Ø±Ø§Ø¨Ø± ÙÙ„Ø§Ù† Ø¨ÙˆØ¯)</summary>
      
  <ul class="steps">
        <div class="code-box"><code class="copyable">  
            # filename: lambda_function.py
import os, json, boto3

dynamodb = boto3.resource("dynamodb")
TABLE = os.getenv("TABLE", "Items")
table = dynamodb.Table(TABLE)

def lambda_handler(event, context):
    # Ø§Ù†ØªØ¸Ø§Ø±: {"id":"123", "owner":"user-1"}
    item_id = event["id"]
    owner = event["owner"]

    try:
        table.delete_item(
            Key={"id": item_id},
            # ÙÙ‚Ø· Ø§Ú¯Ø± owner Ø¨Ø±Ø§Ø¨Ø± Ù…Ù‚Ø¯Ø§Ø± Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
            ConditionExpression="#o = :o",
            ExpressionAttributeNames={"#o": "owner"},
            ExpressionAttributeValues={":o": owner}
        )
        return {"statusCode": 200, "body": json.dumps({"deleted": True})}
    except Exception as e:
        return {"statusCode": 409, "body": json.dumps({"deleted": False, "error": str(e)})}
 
        </code></div>
  </ul>
</details>

</body>
<script src="copy.js"></script>
</html>