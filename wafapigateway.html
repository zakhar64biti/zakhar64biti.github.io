<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>ุฑุงูููุง ฺฏุงูโุจูโฺฏุงู: ุงุชุตุงู AWS WAFv2 ุจู API Gateway (REST)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; --ok:#34d399; --warn:#f59e0b; --err:#ef4444;
      --code:#0b1220; --kbd:#1f2937; --border:#374151;
    }
    body{background:var(--bg);color:var(--text);font-family:IRANSans, Vazirmatn, Inter, system-ui, -apple-system,Segoe UI, Roboto, "Noto Sans Arabic", sans-serif;line-height:1.7;margin:0;padding:40px}
    h1,h2,h3{line-height:1.3}
    h1{font-size:28px;margin-top:0}
    h2{font-size:22px;margin:28px 0 12px}
    h3{font-size:18px;margin:22px 0 10px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin:16px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .muted{color:var(--muted)}
    .tag{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted);margin-left:6px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    code,kbd,pre{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace}
    pre{background:var(--code);border:1px dashed var(--border);border-radius:12px;padding:14px;overflow:auto}
    kbd{background:var(--kbd);border:1px solid var(--border);border-bottom-width:2px;border-radius:6px;padding:2px 6px}
    details{border:1px solid var(--border);border-radius:12px;padding:12px 14px;background:rgba(255,255,255,0.02);margin:10px 0}
    details > summary{cursor:pointer;font-weight:700}
    .steps ol{margin:0;padding-right:18px}
    .steps li{margin:8px 0}
    .grid{display:grid;gap:12px}
    @media (min-width:900px){ .grid-2{grid-template-columns:1fr 1fr} }
    .hr{height:1px;background:var(--border);margin:22px 0}
    .pill{display:inline-block;padding:2px 10px;border-radius:999px;background:#0b1220;border:1px solid var(--border);font-size:12px;margin-left:6px}
    .callout{border-right:4px solid var(--accent);padding:12px;border-radius:12px;background:rgba(34,211,238,.08);border:1px solid var(--border)}
    a{color:var(--accent);text-decoration:none}
  </style>
</head>
<body>

  <h1>ุงุชุตุงู <span class="pill">AWS WAFv2</span> ุจู <span class="pill">API Gateway (REST API)</span></h1>
  <p class="muted">Region ูพุดููุงุฏ: <b>us-east-1</b> โ ุงฺฏุฑ API ุฏุฑ ุฑุฌู ุฏฺฏุฑ ุงุณุชุ Web ACL ุจุงุฏ ููุงู ุฑุฌู ุจุงุดุฏ.</p>

  <div class="card">
    <h2>ููุฑุณุช ุณุฑุน</h2>
    <ol>
      <li><a href="#prereq">ูพุดโูุงุฒูุง</a></li>
      <li><a href="#waf-create">ุณุงุฎุช Web ACL (WAF)</a></li>
      <li><a href="#associate">ูุตูโฺฉุฑุฏู WAF ุจู Stageู API</a></li>
      <li><a href="#logging">ูุนุงูโฺฉุฑุฏู ูุงฺฏ WAF</a></li>
      <li><a href="#test">ุชุณุช ู ุงุนุชุจุงุฑุณูุฌ</a></li>
      <li><a href="#troubleshoot">ุนุจโุงุจ ุณุฑุน</a></li>
      <li><a href="#cleanup">ูพุงฺฉโุณุงุฒ ููุงุจุน</a></li>
      <li><a href="#tips">ูฺฉุงุช ุชฺฉูู (HTTP API/CloudFront ู ูุฒููโูุง)</a></li>
    </ol>
  </div>

  <div id="prereq" class="card">
    <h2>ฑ) ูพุดโูุงุฒูุง</h2>
    <ul>
      <li>ฺฉ <b>REST API</b> ุงุฒ ููุน API Gateway ุจุง ุญุฏุงูู ฺฉ <b>Stage</b> (ูุซูุงู <code>prod</code>)</li>
      <li>ุฏุณุชุฑุณ ฺฉูุณูู ุจุง ูุฌูุฒูุง ูุงุฒู ุจุฑุง <b>WAF</b> ู <b>API Gateway</b></li>
      <li>Prefix ูุงูโฺฏุฐุงุฑ ูพุดููุงุฏ: <code>ws-lab</code> (ุฏูุฎูุงู)</li>
    </ul>
    <p class="callout">ุงฺฏุฑ API ุดูุง ุงุฒ ููุน <b>HTTP API</b> ุงุณุชุ ุงุชุตุงู ูุณุชูู ูุซู REST API ุงูุฌุงู ููโุดูุฏุ ูุนูููุงู ุจุงุฏ API ุฑุง ูพุดุช <b>CloudFront</b> ูุฑุงุฑ ุฏูุฏ ู <b>WAF</b> ุฑุง ุฑู ุชูุฒุน CloudFront ุจุจูุฏุฏ.</p>
  </div>

  <div id="waf-create" class="card steps">
    <h2>ฒ) ุณุงุฎุช Web ACL (WAF)</h2>
    <ol>
      <li>ุจู ฺฉูุณูู AWS ุจุฑู โ ุฌุณุชุฌู: <b>WAF &amp; Shield</b> โ <b>AWS WAF</b>.</li>
      <li><b>Web ACLs</b> โ <b>Create web ACL</b>:
        <ul>
          <li><b>Name:</b> <code>ws-lab-api-waf</code></li>
          <li><b>Region:</b> ููุงู ุฑุฌู API (ูุซูุงู <code>US East (N. Virginia)</code>)</li>
          <li><b>Default action:</b> <span class="ok">Allow</span> (ูพุดููุงุฏ)</li>
        </ul>
      </li>
      <li>ุฏุฑ ุจุฎุด <b>Rules</b>ุ Rule Groupโูุง ูุฏุฑุชโุดุฏูู AWS ุฑุง ุงุถุงูู ฺฉู:
        <ul>
          <li><code>AWSManagedRulesCommonRuleSet</code> (CRS)</li>
          <li><code>AWSManagedRulesKnownBadInputsRuleSet</code></li>
          <li><code>AWSManagedRulesSQLiRuleSet</code></li>
          <li><code>AWSManagedRulesAmazonIpReputationList</code></li>
        </ul>
      </li>
      <li>(ุงุฎุชุงุฑ) Rule ูุญุฏูุฏุช ูุฑุฎ:
        <ul>
          <li><b>Add rule</b> โ <b>Add my own rules</b> โ <b>Rate-based</b></li>
          <li><b>Name:</b> <code>limit-2k-requests-per-5m</code>ุ <b>Rate:</b> 2000 ุฏุฑ 5 ุฏููู (ุจุฑุง ูุฑ IP)</li>
        </ul>
      </li>
      <li>ุงูููุช Ruleูุง ุฑุง ููุทู ุจฺู: Allowlist (ุงฺฏุฑ ุฏุงุฑ) โ Rate-based โ Managed Rule Groups โ Default Allow.</li>
      <li><b>Create web ACL</b>.</li>
    </ol>
  </div>

  <div id="associate" class="card">
    <h2>ณ) ุงุชุตุงู Web ACL ุจู Stageู API Gateway</h2>

    <details open>
      <summary>ุฑูุด ุงูู) ุงุฒ ุฏุงุฎู ฺฉูุณูู API Gateway</summary>
      <ol>
        <li>ฺฉูุณูู โ <b>API Gateway</b> โ API ููุฑุฏ ูุธุฑ (ููุน <b>REST</b>).</li>
        <li>ููู ุณูุช ฺูพ: <b>Stages</b> โ ุงุณุชุฌ (ูุซูุงู <code>prod</code>).</li>
        <li>ุชุจ ุง ุจุฎุด <b>AWS WAF web ACL</b> โ <b>Associate web ACL</b>.</li>
        <li><b>Select existing web ACL</b> โ <code>ws-lab-api-waf</code> โ <b>Associate</b>.</li>
      </ol>
    </details>

    <details>
      <summary>ุฑูุด ุจ) ุงุฒ ุฏุงุฎู ฺฉูุณูู AWS WAF</summary>
      <ol>
        <li><b>WAF</b> โ <b>Web ACLs</b> โ ุฑู <code>ws-lab-api-waf</code> ฺฉูฺฉ ฺฉู.</li>
        <li>ุชุจ <b>Associations</b> โ <b>Add association</b> โ <b>API Gateway</b>.</li>
        <li>API ู <b>Stage</b> ูุฏู ุฑุง ุงูุชุฎุงุจ ฺฉู โ <b>Add</b>.</li>
      </ol>
      <p class="muted">ูุฑูุช ARN ุงุณุชุฌ REST: <code>arn:aws:apigateway:&lt;region&gt;::/restapis/&lt;api-id&gt;/stages/&lt;stage-name&gt;</code></p>
    </details>
  </div>

  <div id="logging" class="card steps">
    <h2>ด) ูุนุงูโฺฉุฑุฏู ูุงฺฏ WAF (ูพุดููุงุฏ ุจุฑุง ุฏุจุงฺฏ)</h2>
    <ol>
      <li>WAF โ <b>Web ACLs</b> โ <code>ws-lab-api-waf</code> โ ุชุจ <b>Logging and metrics</b>.</li>
      <li><b>Enable logging</b>:
        <ul>
          <li>ููุตุฏ: <b>CloudWatch Logs</b> (ุณุงุฏู)ุ ุง <b>Kinesis Firehose โ S3</b> (ุขุฑุดู/ุขูุงูุฒ).</li>
        </ul>
      </li>
      <li>ุฐุฎุฑู ฺฉู. (ุจู ูุฒููู ูุงฺฏ ุชูุฌู ฺฉู.)</li>
    </ol>
  </div>

  <div id="test" class="card">
    <h2>ต) ุชุณุช ู ุงุนุชุจุงุฑุณูุฌ</h2>
    <ol>
      <li>ุงุฒ ุตูุญูู ุงุณุชุฌุ <b>Invoke URL</b> ุฑุง ุจุฑุฏุงุฑ.</li>
      <li>ฺฉ ุฏุฑุฎูุงุณุช ุจุง ูุฑูุฏ ูุดฺฉูฺฉ (SQLi) ุจูุฑุณุชุ ุงูุชุธุงุฑ <b>403</b>:
        <pre><code># ูููููู ุชุณุช (ุฌุงฺฏุฒู ฺฉูุฏ)
curl -i "https://&lt;api-id&gt;.execute-api.us-east-1.amazonaws.com/prod/resource?name=' OR 1=1--"
</code></pre>
      </li>
      <li>ุฏุฑ <b>CloudWatch Logs</b> ููุตุฏ ูุงฺฏ WAFุ Eventูุง <b>Blocked</b> ุฑุง ุจุฑุฑุณ ฺฉูุ ูุงู Ruleู ูุญุฑฺฉ ุจุงุฏ ุซุจุช ุดุฏู ุจุงุดุฏ.</li>
    </ol>
  </div>

  <div id="troubleshoot" class="card">
    <h2>ถ) ุนุจโุงุจ ุณุฑุน</h2>
    <ul>
      <li><b>ุงุซุฑ WAF ุฑุง ููโุจูุ</b> ูุทูุฆู ุดู Association ุฑู <b>Stage ุฏุฑุณุช</b> ุงูุฌุงู ุดุฏู ู ููุงู Stage ุฑุง Invoke ูโฺฉู.</li>
      <li><b>API ุงุฒ ููุน HTTP API ุงุณุชุ</b> ุจุฑุง HTTP API ูุนูููุงู WAF ุฑุง ุฑู <b>CloudFront</b> ุฌูู API ูโฺฏุฐุงุฑูุฏ (ุจุฎุด ูฺฉุงุช ุชฺฉูู ุฑุง ุจุจู).</li>
      <li><b>Block ุจุด ุงุฒ ุญุฏ ุงุณุชุ</b> Rule Groupูุง ุฑุง ุงุจุชุฏุง ุฑู <b>Count</b> ุจฺฏุฐุงุฑุ ูุงฺฏโูุง ุฑุง ุจุฑุฑุณ ฺฉูุ ุจุนุฏ ุจู <b>Block</b> ุชุบุฑ ุจุฏู.</li>
      <li><b>Rate-based ุชูุธู ูุณุชุ</b> ุงฺฏุฑ Flood ุฏุงุฑุ ฺฉ Rule ูุฑุฎโูุญูุฑ per-IP ุงุถุงูู ฺฉู (ูุซูุงู 2000/5m).</li>
    </ul>
  </div>

  <div id="cleanup" class="card">
    <h2>ท) ูพุงฺฉโุณุงุฒ (ุฌููฺฏุฑ ุงุฒ ูุฒููู ูุงุฎูุงุณุชู)</h2>
    <ol>
      <li>ุฏุฑ WAF ุง API Gatewayุ <b>Disassociate</b> ุฑุง ุงุฒ ุฑู Stage ุงูุฌุงู ุจุฏู.</li>
      <li>ุฏุฑ WAFุ <b>Web ACL</b> ุฑุง ุญุฐู ฺฉู ุงฺฏุฑ ุฏฺฏุฑ ูุงุฒู ูุณุช.</li>
      <li>ุงฺฏุฑ <b>Logging</b> ูุนุงู ฺฉุฑุฏ (CloudWatch/Firehose/S3)ุ ุฏุฑ ุตูุฑุช ุนุฏู ูุงุฒ ุบุฑูุนุงู/ุญุฐู ฺฉู.</li>
    </ol>
  </div>

  <div id="tips" class="card">
    <h2>ธ) ูฺฉุงุช ุชฺฉูู</h2>
    <h3>HTTP API + CloudFront + WAF</h3>
    <p>ุงฺฏุฑ API ุดูุง <b>HTTP API</b> ุงุณุช ู ูโุฎูุงู WAF ุฏุงุดุชู ุจุงุด:</p>
    <ol>
      <li>ฺฉ ุชูุฒุน <b>CloudFront</b> ุจุณุงุฒ ฺฉู ูุจุฏุฃ ุขู <b>HTTP API</b> ุดูุง ุจุงุดุฏ.</li>
      <li>ฺฉ <b>Web ACL (Global/CloudFront)</b> ุจุณุงุฒ ุง ููุงู Web ACL ููุงุณุจ CloudFront ุฑุง ุงูุชุฎุงุจ ฺฉู.</li>
      <li>ุงุฒ ุชุจ <b>Associations</b> ุฏุฑ WAFุ ุขู Web ACL ุฑุง ุจู ุชูุฒุน CloudFront ูุตู ฺฉู.</li>
    </ol>

    <h3>ูุฒูู ู ุธุฑูุช (WCU)</h3>
    <ul>
      <li>ูุฑ Rule/Rule Group ููุฏุงุฑ <b>WCU</b> ูุตุฑู ูโฺฉูุฏ.</li>
      <li>Managed Rule Groupูุง ูุฒููู ุฌุฏุงฺฏุงูู ุฏุงุฑูุฏุ Logging ูู ูุฒููู ุฎูุฏ ุฑุง ุฏุงุฑุฏ.</li>
      <li>ุจุฑุง ูุญุท ุชูุฑูุ ุจุง ุญุฏุงูู Ruleูุง ุดุฑูุน ฺฉู ู ุจู ุชุฏุฑุฌ ุงุถุงูู ฺฉู.</li>
    </ul>
  </div>

  <div class="hr"></div>
  <p class="muted">ุชููโุดุฏู ุจุฑุง ุชูุฑู ฺฉูุณูู AWS โ ููุณูุฏู: ุฏูุณุชู ููุดฺฏ ุดูุง ๐</p>
</body>
</html>
