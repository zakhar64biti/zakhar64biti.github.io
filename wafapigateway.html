<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>راهنمای گام‌به‌گام: اتصال AWS WAFv2 به API Gateway (REST)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; --ok:#34d399; --warn:#f59e0b; --err:#ef4444;
      --code:#0b1220; --kbd:#1f2937; --border:#374151;
    }
    body{background:var(--bg);color:var(--text);font-family:IRANSans, Vazirmatn, Inter, system-ui, -apple-system,Segoe UI, Roboto, "Noto Sans Arabic", sans-serif;line-height:1.7;margin:0;padding:40px}
    h1,h2,h3{line-height:1.3}
    h1{font-size:28px;margin-top:0}
    h2{font-size:22px;margin:28px 0 12px}
    h3{font-size:18px;margin:22px 0 10px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin:16px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .muted{color:var(--muted)}
    .tag{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted);margin-left:6px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    code,kbd,pre{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Courier New", monospace}
    pre{background:var(--code);border:1px dashed var(--border);border-radius:12px;padding:14px;overflow:auto}
    kbd{background:var(--kbd);border:1px solid var(--border);border-bottom-width:2px;border-radius:6px;padding:2px 6px}
    details{border:1px solid var(--border);border-radius:12px;padding:12px 14px;background:rgba(255,255,255,0.02);margin:10px 0}
    details > summary{cursor:pointer;font-weight:700}
    .steps ol{margin:0;padding-right:18px}
    .steps li{margin:8px 0}
    .grid{display:grid;gap:12px}
    @media (min-width:900px){ .grid-2{grid-template-columns:1fr 1fr} }
    .hr{height:1px;background:var(--border);margin:22px 0}
    .pill{display:inline-block;padding:2px 10px;border-radius:999px;background:#0b1220;border:1px solid var(--border);font-size:12px;margin-left:6px}
    .callout{border-right:4px solid var(--accent);padding:12px;border-radius:12px;background:rgba(34,211,238,.08);border:1px solid var(--border)}
    a{color:var(--accent);text-decoration:none}
  </style>
</head>
<body>

  <h1>اتصال <span class="pill">AWS WAFv2</span> به <span class="pill">API Gateway (REST API)</span></h1>
  <p class="muted">Region پیشنهادی: <b>us-east-1</b> — اگر API در ریجن دیگری است، Web ACL باید همان ریجن باشد.</p>

  <div class="card">
    <h2>فهرست سریع</h2>
    <ol>
      <li><a href="#prereq">پیش‌نیازها</a></li>
      <li><a href="#waf-create">ساخت Web ACL (WAF)</a></li>
      <li><a href="#associate">وصل‌کردن WAF به Stageِ API</a></li>
      <li><a href="#logging">فعال‌کردن لاگ WAF</a></li>
      <li><a href="#test">تست و اعتبارسنجی</a></li>
      <li><a href="#troubleshoot">عیب‌یابی سریع</a></li>
      <li><a href="#cleanup">پاک‌سازی منابع</a></li>
      <li><a href="#tips">نکات تکمیلی (HTTP API/CloudFront و هزینه‌ها)</a></li>
    </ol>
  </div>

  <div id="prereq" class="card">
    <h2>۱) پیش‌نیازها</h2>
    <ul>
      <li>یک <b>REST API</b> از نوع API Gateway با حداقل یک <b>Stage</b> (مثلاً <code>prod</code>)</li>
      <li>دسترسی کنسول با مجوزهای لازم برای <b>WAF</b> و <b>API Gateway</b></li>
      <li>Prefix نام‌گذاری پیشنهادی: <code>ws-lab</code> (دلخواه)</li>
    </ul>
    <p class="callout">اگر API شما از نوع <b>HTTP API</b> است، اتصال مستقیم مثل REST API انجام نمی‌شود؛ معمولاً باید API را پشت <b>CloudFront</b> قرار دهید و <b>WAF</b> را روی توزیع CloudFront ببندید.</p>
  </div>

  <div id="waf-create" class="card steps">
    <h2>۲) ساخت Web ACL (WAF)</h2>
    <ol>
      <li>به کنسول AWS برو → جستجو: <b>WAF &amp; Shield</b> → <b>AWS WAF</b>.</li>
      <li><b>Web ACLs</b> → <b>Create web ACL</b>:
        <ul>
          <li><b>Name:</b> <code>ws-lab-api-waf</code></li>
          <li><b>Region:</b> همان ریجن API (مثلاً <code>US East (N. Virginia)</code>)</li>
          <li><b>Default action:</b> <span class="ok">Allow</span> (پیشنهادی)</li>
        </ul>
      </li>
      <li>در بخش <b>Rules</b>، Rule Group‌های مدیریت‌شدهٔ AWS را اضافه کن:
        <ul>
          <li><code>AWSManagedRulesCommonRuleSet</code> (CRS)</li>
          <li><code>AWSManagedRulesKnownBadInputsRuleSet</code></li>
          <li><code>AWSManagedRulesSQLiRuleSet</code></li>
          <li><code>AWSManagedRulesAmazonIpReputationList</code></li>
        </ul>
      </li>
      <li>(اختیاری) Rule محدودیت نرخ:
        <ul>
          <li><b>Add rule</b> → <b>Add my own rules</b> → <b>Rate-based</b></li>
          <li><b>Name:</b> <code>limit-2k-requests-per-5m</code>، <b>Rate:</b> 2000 در 5 دقیقه (برای هر IP)</li>
        </ul>
      </li>
      <li>اولویت Ruleها را منطقی بچین: Allowlist (اگر داری) → Rate-based → Managed Rule Groups → Default Allow.</li>
      <li><b>Create web ACL</b>.</li>
    </ol>
  </div>

  <div id="associate" class="card">
    <h2>۳) اتصال Web ACL به Stageِ API Gateway</h2>

    <details open>
      <summary>روش الف) از داخل کنسول API Gateway</summary>
      <ol>
        <li>کنسول → <b>API Gateway</b> → API مورد نظر (نوع <b>REST</b>).</li>
        <li>منوی سمت چپ: <b>Stages</b> → استیج (مثلاً <code>prod</code>).</li>
        <li>تب یا بخش <b>AWS WAF web ACL</b> → <b>Associate web ACL</b>.</li>
        <li><b>Select existing web ACL</b> → <code>ws-lab-api-waf</code> → <b>Associate</b>.</li>
      </ol>
    </details>

    <details>
      <summary>روش ب) از داخل کنسول AWS WAF</summary>
      <ol>
        <li><b>WAF</b> → <b>Web ACLs</b> → روی <code>ws-lab-api-waf</code> کلیک کن.</li>
        <li>تب <b>Associations</b> → <b>Add association</b> → <b>API Gateway</b>.</li>
        <li>API و <b>Stage</b> هدف را انتخاب کن → <b>Add</b>.</li>
      </ol>
      <p class="muted">فرمت ARN استیج REST: <code>arn:aws:apigateway:&lt;region&gt;::/restapis/&lt;api-id&gt;/stages/&lt;stage-name&gt;</code></p>
    </details>
  </div>

  <div id="logging" class="card steps">
    <h2>۴) فعال‌کردن لاگ WAF (پیشنهادی برای دیباگ)</h2>
    <ol>
      <li>WAF → <b>Web ACLs</b> → <code>ws-lab-api-waf</code> → تب <b>Logging and metrics</b>.</li>
      <li><b>Enable logging</b>:
        <ul>
          <li>مقصد: <b>CloudWatch Logs</b> (ساده)، یا <b>Kinesis Firehose → S3</b> (آرشیو/آنالیز).</li>
        </ul>
      </li>
      <li>ذخیره کن. (به هزینهٔ لاگ توجه کن.)</li>
    </ol>
  </div>

  <div id="test" class="card">
    <h2>۵) تست و اعتبارسنجی</h2>
    <ol>
      <li>از صفحهٔ استیج، <b>Invoke URL</b> را بردار.</li>
      <li>یک درخواست با ورودی مشکوک (SQLi) بفرست؛ انتظار <b>403</b>:
        <pre><code># نمونهٔ تست (جایگزین کنید)
curl -i "https://&lt;api-id&gt;.execute-api.us-east-1.amazonaws.com/prod/resource?name=' OR 1=1--"
</code></pre>
      </li>
      <li>در <b>CloudWatch Logs</b> مقصد لاگ WAF، Eventهای <b>Blocked</b> را بررسی کن؛ نام Ruleِ محرک باید ثبت شده باشد.</li>
    </ol>
  </div>

  <div id="troubleshoot" class="card">
    <h2>۶) عیب‌یابی سریع</h2>
    <ul>
      <li><b>اثر WAF را نمی‌بینی؟</b> مطمئن شو Association روی <b>Stage درست</b> انجام شده و همان Stage را Invoke می‌کنی.</li>
      <li><b>API از نوع HTTP API است؟</b> برای HTTP API معمولاً WAF را روی <b>CloudFront</b> جلوی API می‌گذارند (بخش نکات تکمیلی را ببین).</li>
      <li><b>Block بیش از حد است؟</b> Rule Groupها را ابتدا روی <b>Count</b> بگذار، لاگ‌ها را بررسی کن، بعد به <b>Block</b> تغییر بده.</li>
      <li><b>Rate-based تنظیم نیست؟</b> اگر Flood داری، یک Rule نرخ‌محور per-IP اضافه کن (مثلاً 2000/5m).</li>
    </ul>
  </div>

  <div id="cleanup" class="card">
    <h2>۷) پاک‌سازی (جلوگیری از هزینهٔ ناخواسته)</h2>
    <ol>
      <li>در WAF یا API Gateway، <b>Disassociate</b> را از روی Stage انجام بده.</li>
      <li>در WAF، <b>Web ACL</b> را حذف کن اگر دیگر لازم نیست.</li>
      <li>اگر <b>Logging</b> فعال کردی (CloudWatch/Firehose/S3)، در صورت عدم نیاز غیرفعال/حذف کن.</li>
    </ol>
  </div>

  <div id="tips" class="card">
    <h2>۸) نکات تکمیلی</h2>
    <h3>HTTP API + CloudFront + WAF</h3>
    <p>اگر API شما <b>HTTP API</b> است و می‌خواهی WAF داشته باشی:</p>
    <ol>
      <li>یک توزیع <b>CloudFront</b> بساز که مبدأ آن <b>HTTP API</b> شما باشد.</li>
      <li>یک <b>Web ACL (Global/CloudFront)</b> بساز یا همان Web ACL مناسب CloudFront را انتخاب کن.</li>
      <li>از تب <b>Associations</b> در WAF، آن Web ACL را به توزیع CloudFront وصل کن.</li>
    </ol>

    <h3>هزینه و ظرفیت (WCU)</h3>
    <ul>
      <li>هر Rule/Rule Group مقداری <b>WCU</b> مصرف می‌کند.</li>
      <li>Managed Rule Groupها هزینهٔ جداگانه دارند؛ Logging هم هزینهٔ خود را دارد.</li>
      <li>برای محیط تمرینی، با حداقل Ruleها شروع کن و به تدریج اضافه کن.</li>
    </ul>
  </div>

  <div class="hr"></div>
  <p class="muted">تهیه‌شده برای تمرین کنسول AWS — نویسنده: دوستِ همیشگی شما 😉</p>
</body>
</html>
