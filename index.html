<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Code Cheat Sheet</title>
  <link rel="stylesheet" href="style.css">

</head>
<body dir="rtl">



  <h1>📒 My Cheat Sheet</h1>

<div class="menu-part">
    <!-- trains part -->

<details>
  <summary>تمرینات اردوی ملی مهارت ۷ تمرین</summary>
 <div class="details">
 <a href="trainone.html">تمرین اول (nginx base auth)</a>
 <a href="trainthree.html">تمرین سوم (create and push 1000 file in s3)</a>
 </div>
</details> 

<!-- terraform part -->

<details>
  <summary>تمرینات بخش کاربا terraform</summary>
 <div class="details">
  <a href="terraformec2.html">create ec2 via terraform</a>
 </div>
</details> 

<!-- sql dbs part -->

<details>
  <summary>کوئری‌های پایه و حیاتی: DATABASES</summary>
 <div class="details">
  <a href="relationshipdbs.html">MySQL / MariaDB</a>
  <a href="redis.html">Redis</a>
 </div>
</details> 

<!-- important path -->

<details>
  <summary>لیست مسیرهای مهم سیستم‌ها و سرویس‌ها</summary>
 <div class="details">
  <a href="path.html">path</a>
 </div>
</details> 

<!-- vpc part -->

<details>
  <summary>بخش کار با vpc</summary>
 <div class="details">
  <a href="vpcpeering.html">vpc peering</a>
  <a href="vpcendpointslists.html">🟢 لیست VPC Endpointهای خیلی مهم</a>
 </div>
</details> 

<!-- IRI worldskill projects -->

<details>
  <summary> IRI worldskill projects </summary>
 <div class="details">
  <a href="iran22skillday2.html">IRI 21 Day2</a>
 </div>
</details> 

</div>






   <!-- بخش Linux Commands -->
  <h2 style="text-align:center;">🐧 Linux Commands</h2>

  <div class="note">نمایش مسیر فعلی</div>
  <div class="code-box"><code>pwd</code></div>

  <hr class="separator">

  <div class="note">لیست فایل‌ها و پوشه‌ها</div>
  <div class="code-box"><code>ls -l</code></div>

  <hr class="separator">

  <div class="note">تغییر دایرکتوری</div>
  <div class="code-box"><code>cd /path/to/dir</code></div>

  <hr class="separator">

  <div class="note">ایجاد دایرکتوری جدید</div>
  <div class="code-box"><code>mkdir new_folder</code></div>

  <hr class="separator">

  <div class="note">ایجاد فایل خالی</div>
  <div class="code-box"><code>touch file.txt</code></div>

  <hr class="separator">

  <div class="note">نمایش محتویات فایل</div>
  <div class="code-box"><code>cat file.txt</code></div>

  <hr class="separator">

  <div class="note">ویرایش فایل با nano</div>
  <div class="code-box"><code>nano file.txt</code></div>

  <hr class="separator">

  <div class="note">کپی فایل</div>
  <div class="code-box"><code>cp source.txt dest.txt</code></div>

  <hr class="separator">

  <div class="note">جابجایی یا تغییر نام فایل</div>
  <div class="code-box"><code>mv old.txt new.txt</code></div>

  <hr class="separator">

  <div class="note">حذف فایل یا پوشه</div>
  <div class="code-box"><code>rm file.txt</code><br><code>rm -r folder/</code></div>

  <hr class="separator">

  <div class="note">جستجو داخل فایل</div>
  <div class="code-box"><code>grep "word" file.txt</code></div>

  <hr class="separator">

  <div class="note">مشاهده وضعیت پروسه‌ها</div>
  <div class="code-box"><code>ps aux</code></div>

  <hr class="separator">

  <div class="note">یافتن پروسه با نام</div>
  <div class="code-box"><code>ps aux | grep nginx</code></div>

  <hr class="separator">

  <div class="note">بستن پروسه</div>
  <div class="code-box"><code>kill -9 PID</code></div>

  <hr class="separator">

  <div class="note">نمایش فضای دیسک</div>
  <div class="code-box"><code>df -h</code></div>

  <hr class="separator">

  <div class="note">نمایش فضای پوشه‌ها</div>
  <div class="code-box"><code>du -sh *</code></div>

  <hr class="separator">

  <div class="note">دانلود فایل با wget</div>
  <div class="code-box"><code>wget http://example.com/file.zip</code></div>

  <hr class="separator">

  <div class="note">دانلود با curl</div>
  <div class="code-box"><code>curl -O http://example.com/file.zip</code></div>

  <hr class="separator">

  <div class="note">اکسترت کردن فایل zip</div>
  <div class="code-box"><code>unzip file.zip</code></div>

  <hr class="separator">

  <div class="note">اکسترت کردن فایل tar.gz</div>
  <div class="code-box"><code>tar -xvzf file.tar.gz</code></div>

  <hr class="separator">

  
<hr class="separator">
<div class="note">تایید خودکار کاربر در Amazon Cognito</div>
  <div class="code-box"><code>
    def lambda_handler(event, context):
    # اگر می‌خوای کاربرهای ثبت‌شده خودتو اتومات تایید کنی
    event['response']['autoConfirmUser'] = True
    event['response']['autoVerifyEmail'] = True
    event['response']['autoVerifyPhone'] = True

    return event
  </code></div>

  <div class="note">تابع زمان‌بندی شده (Scheduled Lambda) برای پاکسازی فایل‌های قدیمی در S3</div>
  <div class="code-box"><code>
   const AWS = require('aws-sdk');
const s3 = new AWS.S3();
const DAY = 24 * 60 * 60 * 1000;

exports.handler = async (event) => {
    const bucket = "your-bucket-name";
    const prefix = "uploads/";

    const listResp = await s3.listObjectsV2({
        Bucket: bucket,
        Prefix: prefix
    }).promise();

    const objects = listResp.Contents;

    const now = new Date().getTime();

    const oldObjects = objects.filter(obj => {
        const lastModified = new Date(obj.LastModified).getTime();
        return (now - lastModified) > (7 * DAY); // قدیمی‌تر از 7 روز
    });

    if (oldObjects.length === 0) {
        return { statusCode: 200, body: "No old files" };
    }

    // حذف فایل‌های قدیمی
    const delParams = {
        Bucket: bucket,
        Delete: {
            Objects: oldObjects.map(obj => ({ Key: obj.Key }))
        }
    };
    await s3.deleteObjects(delParams).promise();

    return { statusCode: 200, body: `Deleted ${oldObjects.length} files` };
};
  </code></div>

    <div class="note">1) Hello World (Node.js) — تست سریع فانکشن و ساختار پاسخ API Gateway</div>
  <div class="code-box"><code>
// index.js
exports.handler = async (event) => {
  return {
    statusCode: 200,
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ ok: true, message: "Hello from Lambda!" })
  };
};
  </code></div>

  <div class="note">2) لاگ‌برداری و مشاهده در CloudWatch (Python)</div>
  <div class="code-box"><code>
import json, os, logging
logger = logging.getLogger()
logger.setLevel(logging.INFO)

def lambda_handler(event, context):
    logger.info({"event": event, "function": context.function_name})
    return {"statusCode":200, "body": json.dumps({"env": dict(os.environ)})}
  </code></div>

  <hr class="separator">

  <h2>🔹 API Gateway ↔ Lambda</h2>

  <div class="note">3) REST Endpoint ساده (Node.js) — مسیر health و echo</div>
  <div class="code-box"><code>
// index.js
exports.handler = async (event) => {
  const path = event.rawPath || event.path || "/";
  if (path === "/health") {
    return { statusCode: 200, body: "OK" };
  }
  return { statusCode: 200, headers:{"Content-Type":"application/json"},
           body: JSON.stringify({ received: event }) };
};
  </code></div>

  <div class="note">4) اعتبارسنجی ورودی API و پاسخ خطا (Python)</div>
  <div class="code-box"><code>
import json
def lambda_handler(event, context):
    try:
        body = json.loads(event.get("body") or "{}")
        if "name" not in body:
            return {"statusCode":400, "body":"Missing 'name'"}
        return {"statusCode":200, "body": json.dumps({"hello": body["name"]})}
    except Exception as e:
        return {"statusCode":500, "body": str(e)}
  </code></div>

  <hr class="separator">

  <h2>🔹 S3 Trigger سناریوها</h2>

  <div class="note">5) Thumbnail ساز تصویر بعد از آپلود S3 (Python, Pillow لازم دارد)</div>
  <div class="code-box"><code>
# requirements: pillow
import boto3, os
from PIL import Image
s3 = boto3.client("s3")
OUT_PREFIX = "thumbs/"
SIZE = (300, 300)

def lambda_handler(event, context):
    record = event["Records"][0]
    b = record["s3"]["bucket"]["name"]
    k = record["s3"]["object"]["key"]

    tmp_in = "/tmp/in"
    tmp_out = "/tmp/out.jpg"
    s3.download_file(b, k, tmp_in)

    img = Image.open(tmp_in)
    img.thumbnail(SIZE)
    img.save(tmp_out, "JPEG")

    out_key = OUT_PREFIX + os.path.basename(k) + ".jpg"
    s3.upload_file(tmp_out, b, out_key, ExtraArgs={"ContentType":"image/jpeg"})
    return {"thumb": out_key}
  </code></div>

  <div class="note">6) JSON Validator روی S3 Object (Node.js) — ریجکت/ثبت مشکل</div>
  <div class="code-box"><code>
// index.js
const AWS = require("aws-sdk");
const s3 = new AWS.S3();

exports.handler = async (event) => {
  const { name: Bucket } = event.Records[0].s3.bucket;
  const Key = decodeURIComponent(event.Records[0].s3.object.key);
  const data = await s3.getObject({ Bucket, Key }).promise();
  try {
    JSON.parse(data.Body.toString("utf-8"));
    console.log("Valid JSON:", Key);
  } catch (e) {
    console.error("Invalid JSON:", Key, e);
  }
  return { ok: true };
};
  </code></div>

  <hr class="separator">

  <h2>🔹 DynamoDB CRUD</h2>

  <div class="note">7) PutItem + GetItem (Python) — جدول با کلید پارتیشن id</div>
  <div class="code-box"><code>
import json, os, boto3, uuid
db = boto3.resource("dynamodb")
table = db.Table(os.environ.get("TABLE", "items"))

def lambda_handler(event, context):
    body = json.loads(event.get("body") or "{}")
    if event.get("httpMethod") == "POST":
        item = {"id": str(uuid.uuid4()), **body}
        table.put_item(Item=item)
        return {"statusCode":201, "body": json.dumps(item)}

    if event.get("httpMethod") == "GET":
        id_ = (event.get("pathParameters") or {}).get("id")
        if not id_:
            return {"statusCode":400, "body":"missing id"}
        res = table.get_item(Key={"id": id_})
        return {"statusCode":200, "body": json.dumps(res.get("Item"))}

    return {"statusCode":405, "body":"Method Not Allowed"}
  </code></div>

  <div class="note">8) UpdateItem شرطی (Node.js) — جلوگیری از overwrite ناخواسته</div>
  <div class="code-box"><code>
const AWS = require("aws-sdk");
const ddb = new AWS.DynamoDB.DocumentClient();
const TABLE = process.env.TABLE || "items";

exports.handler = async (event) => {
  const { id, ...fields } = JSON.parse(event.body || "{}");
  await ddb.update({
    TableName: TABLE,
    Key: { id },
    UpdateExpression: "SET #n = :n",
    ExpressionAttributeNames: { "#n": "name" },
    ExpressionAttributeValues: { ":n": fields.name },
    ConditionExpression: "attribute_exists(id)"
  }).promise();
  return { statusCode: 200, body: "updated" };
};
  </code></div>

  <hr class="separator">

  <h2>🔹 EventBridge / زمان‌بندی</h2>

  <div class="note">9) پاکسازی فایل‌های قدیمی در S3 (Node.js) — Scheduled</div>
  <div class="code-box"><code>
const AWS = require("aws-sdk");
const s3 = new AWS.S3();
const DAY = 24 * 60 * 60 * 1000;
exports.handler = async () => {
  const Bucket = process.env.BUCKET;
  const Prefix = process.env.PREFIX || "";
  const list = await s3.listObjectsV2({ Bucket, Prefix }).promise();
  const now = Date.now();
  const old = (list.Contents || []).filter(o => (now - new Date(o.LastModified).getTime()) > 7*DAY);
  if (!old.length) return { statusCode:200, body:"no old files" };
  await s3.deleteObjects({ Bucket, Delete: { Objects: old.map(o => ({Key:o.Key})) } }).promise();
  return { statusCode:200, body:`deleted ${old.length}` };
};
  </code></div>

  <div class="note">10) Heartbeat ثبت وضعیت در CloudWatch Metric (Python)</div>
  <div class="code-box"><code>
import boto3, os, time
cw = boto3.client("cloudwatch")
def lambda_handler(event, context):
    cw.put_metric_data(
      Namespace="WorldSkills/Lambda",
      MetricData=[{
        "MetricName":"Heartbeat",
        "Value":1, "Unit":"Count",
        "Dimensions":[{"Name":"Function","Value":context.function_name}]
      }]
    )
    return {"ok": True, "ts": int(time.time())}
  </code></div>

  <hr class="separator">

  <h2>🔹 Cognito Triggers</h2>

  <div class="note">11) Pre Sign-up: تأیید خودکار ایمیل/کاربر (Python)</div>
  <div class="code-box"><code>
def lambda_handler(event, context):
    event["response"]["autoConfirmUser"] = True
    event["response"]["autoVerifyEmail"] = True
    return event
  </code></div>

  <div class="note">12) Post Confirmation: ارسال پیام به SNS (Node.js)</div>
  <div class="code-box"><code>
const AWS = require("aws-sdk");
const sns = new AWS.SNS();
exports.handler = async (event) => {
  const user = event.request.userAttributes.email;
  await sns.publish({
    TopicArn: process.env.TOPIC_ARN,
    Message: `New confirmed user: ${user}`
  }).promise();
  return event;
};
  </code></div>

  <hr class="separator">

  <h2>🔹 SNS / SQS الگوها</h2>

  <div class="note">13) Fan-out: API → SNS → (SQS کنسومرهای متعدد) (Node.js: Publisher)</div>
  <div class="code-box"><code>
const AWS = require("aws-sdk");
const sns = new AWS.SNS();
exports.handler = async (event) => {
  const body = JSON.parse(event.body || "{}");
  await sns.publish({ TopicArn: process.env.TOPIC_ARN, Message: JSON.stringify(body) }).promise();
  return { statusCode: 200, body: "published" };
};
  </code></div>

  <div class="note">14) SQS Consumer (Python) — Lambda با تریگر SQS</div>
  <div class="code-box"><code>
import json
def lambda_handler(event, context):
    for rec in event["Records"]:
        msg = json.loads(rec["body"])
        # پردازش پیام
        print("Message:", msg)
    return {"ok": True}
  </code></div>

  <hr class="separator">

  <h2>🔹 ایمیل / SES</h2>

  <div class="note">15) ارسال ایمیل با SES (Python) — بعد از رخداد خاص</div>
  <div class="code-box"><code>
import boto3, os
ses = boto3.client("ses")
SENDER = os.environ.get("SENDER")
def lambda_handler(event, context):
    ses.send_email(
      Source=SENDER,
      Destination={"ToAddresses":[event.get("to","test@example.com")]},
      Message={
        "Subject":{"Data":"WorldSkills Update"},
        "Body":{"Text":{"Data":"Lambda completed successfully."}}
      }
    )
    return {"sent": True}
  </code></div>

  <hr class="separator">

  <h2>🔹 Rekognition / پردازش تصویر</h2>

  <div class="note">16) Label Detection (Node.js) — روی عکس S3</div>
  <div class="code-box"><code>
const AWS = require("aws-sdk");
const rekog = new AWS.Rekognition();
exports.handler = async (event) => {
  const Bucket = event.bucket, Name = event.key;
  const res = await rekog.detectLabels({ Image:{ S3Object:{Bucket, Name} }, MaxLabels: 10 }).promise();
  return { labels: res.Labels.map(l => l.Name) };
};
  </code></div>

  <hr class="separator">

  <h2>🔹 Secrets Manager / Parameter Store</h2>

  <div class="note">17) گرفتن Secret و استفاده امن (Python)</div>
  <div class="code-box"><code>
import boto3, json, os
sm = boto3.client("secretsmanager")
def lambda_handler(event, context):
    sec_arn = os.environ["SECRET_ARN"]
    val = sm.get_secret_value(SecretId=sec_arn)
    secret = json.loads(val["SecretString"])
    # مثلا secret["db_password"]
    return {"has_secret": "db_password" in secret}
  </code></div>

  <div class="note">18) SSM Parameter (Node.js)</div>
  <div class="code-box"><code>
const AWS = require("aws-sdk");
const ssm = new AWS.SSM();
exports.handler = async () => {
  const p = await ssm.getParameter({ Name: process.env.PARAM, WithDecryption: true }).promise();
  return { value: p.Parameter.Value };
};
  </code></div>

  <hr class="separator">

  <h2>🔹 RDS (داخل VPC)</h2>

  <div class="note">19) اتصال به RDS (MySQL) داخل VPC (Node.js) — نیازمند پکیج mysql2 و کانفیگ VPC</div>
  <div class="code-box"><code>
// npm i mysql2  (لایه یا zip آپلود)
const mysql = require("mysql2/promise");
exports.handler = async () => {
  const conn = await mysql.createConnection({
    host: process.env.DB_HOST, user: process.env.DB_USER,
    password: process.env.DB_PASS, database: process.env.DB_NAME
  });
  const [rows] = await conn.execute("SELECT NOW() AS now");
  await conn.end();
  return rows[0];
};
  </code></div>

  <hr class="separator">

  <h2>🔹 Presigned URL (S3)</h2>

  <div class="note">20) ساخت لینک آپلود موقت برای کلاینت (Python)</div>
  <div class="code-box"><code>
import boto3, os
s3 = boto3.client("s3")
def lambda_handler(event, context):
    bucket = os.environ["BUCKET"]; key = event.get("key","uploads/file.bin")
    url = s3.generate_presigned_url(
      "put_object", Params={"Bucket": bucket, "Key": key}, ExpiresIn=900
    )
    return {"upload_url": url, "key": key}
  </code></div>

  <hr class="separator">

  <h2>🔹 Kinesis / Stream Processing</h2>

  <div class="note">21) پردازش رکوردهای Kinesis (Node.js)</div>
  <div class="code-box"><code>
exports.handler = async (event) => {
  for (const rec of event.Records) {
    const payload = Buffer.from(rec.kinesis.data, "base64").toString("utf-8");
    console.log("record:", payload);
  }
  return { ok: true };
};
  </code></div>

  <hr class="separator">

  <h2>🔹 Step Functions</h2>

  <div class="note">22) وظیفه‌ی کوچک برای Orchestrator (Python) — ورودی را enrichment می‌کند</div>
  <div class="code-box"><code>
def lambda_handler(event, context):
    event["enriched"] = True
    return event
  </code></div>

  <hr class="separator">

  <h2>🔹 فیلتر لاگ و متریک</h2>

  <div class="note">23) تولید ساختار لاگ JSON برای فیلترهای CloudWatch (Node.js)</div>
  <div class="code-box"><code>
exports.handler = async () => {
  console.log(JSON.stringify({ level:"INFO", service:"lambda", msg:"started" }));
  console.warn(JSON.stringify({ level:"WARN", code:123, msg:"something odd" }));
  return { ok: true };
};
  </code></div>

  <hr class="separator">

  <h2>🔹 خطا، Retry، DLQ</h2>

  <div class="note">24) الگوی خطا با Retry کنترل‌شده (Python)</div>
  <div class="code-box"><code>
import random, time
def lambda_handler(event, context):
    if random.random() < 0.7:
        raise Exception("temporary failure")  # با Retry تنظیمات Event source حل می‌شود
    return {"ok": True}
  </code></div>

  <hr class="separator">

  <h2>🔹 امنیت و IAM (نمونه سیاست‌ها)</h2>

  <div class="note">25) دسترسی DynamoDB CRUD حداقلی برای یک جدول (JSON)</div>
  <div class="code-box"><code>
{
  "Version":"2012-10-17",
  "Statement":[
    {
      "Effect":"Allow",
      "Action":[ "dynamodb:PutItem","dynamodb:GetItem","dynamodb:UpdateItem","dynamodb:DeleteItem","dynamodb:Query","dynamodb:Scan" ],
      "Resource":[ "arn:aws:dynamodb:REGION:ACCOUNT_ID:table/YourTable" ]
    }
  ]
}
  </code></div>

  <div class="note">26) اجازه دسترسی S3 خاص (Read/Write روی یک Prefix) (JSON)</div>
  <div class="code-box"><code>
{
  "Version":"2012-10-17",
  "Statement":[
    { "Effect":"Allow", "Action":[ "s3:PutObject","s3:GetObject" ],
      "Resource":[ "arn:aws:s3:::your-bucket/uploads/*" ] }
  ]
}
  </code></div>

  <hr class="separator">

  <h2>🔹 بهینه‌سازی و نکات مسابقه</h2>

  <div class="note">27) زمان‌بندی/حافظه/زمان اجرا</div>
  <div class="code-box"><code>
# نکات:
# - Memory بیشتر => CPU بیشتر => سریع‌تر (تا هزینه/زمان بهینه شود)
# - Timeout را با توجه به وابستگی‌های شبکه‌ای (RDS/VPC) تنظیم کن
# - برای پکیج‌های سنگین از Layers استفاده کن
# - برای VPC: ساب‌نت خصوصی + NAT برای دسترسی اینترنتی
  </code></div>

  <div class="note">28) الگوی Handler سبک برای تست سریع (Node.js)</div>
  <div class="code-box"><code>
exports.handler = async (event, context) => {
  return { statusCode:200, headers:{"Content-Type":"text/plain"}, body:"OK" };
};
  </code></div>

  <hr class="separator">

  <h2>🔹 Glue Code های رایج</h2>

  <div class="note">29) Validate امضا/توکن ساده API (Node.js) — هدر سفارشی</div>
  <div class="code-box"><code>
exports.handler = async (event) => {
  const token = (event.headers || {})["x-api-key"];
  if (token !== process.env.API_KEY) return { statusCode:403, body:"Forbidden" };
  return { statusCode:200, body:"Authorized" };
};
  </code></div>

  <div class="note">30) Merge چند ورودی و ارسال به خروجی مشترک (Python)</div>
  <div class="code-box"><code>
def lambda_handler(event, context):
    items = event.get("items", [])
    return {"count": len(items), "items": items}
  </code></div>

   <hr class="separator">

  <!-- سناریو 1 -->
  <h2>🔹 سناریو 1: S3 ➜ Lambda (ساخت Thumbnail بعد از آپلود تصویر)</h2>

  <div class="note"><b>پیش‌نیاز</b>: یک باکت S3 (مثلاً <code>ws-media-bucket</code>)، نقش Lambda با دسترسی خواندن/نوشتن در باکت.</div>

  <div class="note"><b>مراحل کنسول</b></div>
  <ul class="steps">
    <li>S3 ➜ <b>Create bucket</b> ➜ Name: <code>ws-media-bucket</code> ➜ Region ثابت ➜ Create.</li>
    <li>Lambda ➜ <b>Create function</b> ➜ Author from scratch ➜ Name: <code>ws-s3-thumbnail</code> ➜ Runtime: Python 3.12 ➜ Role: <i>Create a new role with basic Lambda permissions</i> ➜ Create.</li>
    <li>Lambda ➜ Configuration ➜ Permissions ➜ Execution role ➜ <b>Add permissions</b> ➜ Attach: (برای تمرین) <code>AmazonS3FullAccess</code> یا پالیسی حداقلی.</li>
    <li>Lambda ➜ Configuration ➜ Triggers ➜ <b>Add trigger</b> ➜ S3: Bucket = <code>ws-media-bucket</code> ➜ Event = <b>PUT</b> (Object Created) ➜ Prefix (اختیاری): <code>uploads/</code> ➜ Add.</li>
    <li>S3 ➜ وارد باکت ➜ <b>Create folder</b>: <code>uploads/</code> ➜ یک تصویر آپلود کن و نتیجه را بررسی کن.</li>
  </ul>

  <div class="note">کد نمونه (اگر <b>Pillow</b> نداری، فعلاً فقط لاگ بگیر):</div>
  <div class="code-box"><code>
# Python 3.12 - نیازمند لایه Pillow برای تولید thumbnail
import boto3, os
from PIL import Image

s3 = boto3.client("s3")
OUT_PREFIX = "thumbs/"
SIZE = (300, 300)

def lambda_handler(event, context):
    record = event["Records"][0]
    b = record["s3"]["bucket"]["name"]
    k = record["s3"]["object"]["key"]

    in_path = "/tmp/in"
    out_path = "/tmp/out.jpg"
    s3.download_file(b, k, in_path)

    img = Image.open(in_path)
    img.thumbnail(SIZE)
    img.save(out_path, "JPEG")

    out_key = OUT_PREFIX + os.path.basename(k) + ".jpg"
    s3.upload_file(out_path, b, out_key, ExtraArgs={"ContentType":"image/jpeg"})
    return {"thumb": out_key}
  </code></div>

  <div class="note warn"><b>عیب‌یابی سریع</b>: AccessDenied ➜ پالیسی S3 روی نقش Lambda؛ No module named PIL ➜ لایه Pillow اضافه کن یا کد را ساده کن.</div>

  <hr class="separator">

  <!-- سناریو 2 -->
  <h2>🔹 سناریو 2: API Gateway ➜ Lambda ➜ DynamoDB (POST/GET ساده)</h2>

  <div class="note"><b>پیش‌نیاز</b>: جدول DynamoDB (نام: <code>ws-items</code>، Partition key: <code>id</code> String). نقش Lambda با PutItem/GetItem.</div>

  <div class="note"><b>مراحل کنسول</b></div>
  <ul class="steps">
    <li>DynamoDB ➜ <b>Create table</b> ➜ Name: <code>ws-items</code> ➜ PK: <code>id</code> (String) ➜ Create.</li>
    <li>Lambda ➜ Create function ➜ Name: <code>ws-api-items</code> ➜ Runtime: Python 3.12 ➜ Role: new basic ➜ Create.</li>
    <li>Lambda ➜ Configuration ➜ Environment variables ➜ <code>TABLE = ws-items</code> ➜ Save.</li>
    <li>Lambda ➜ Permissions ➜ Attach policy حداقلی (Put/Get روی ARN جدول) یا موقتاً <code>AmazonDynamoDBFullAccess</code>.</li>
    <li>API Gateway ➜ Create API ➜ <b>HTTP API</b> ➜ Add integration: Lambda <code>ws-api-items</code>.</li>
    <li>Routes ➜ <b>POST /items</b> و <b>GET /items/{id}</b> ➜ هر دو به همان Lambda.</li>
    <li>Stages ➜ Invoke URL را بردار ➜ با POST و GET تست کن.</li>
  </ul>

  <div class="note">کد Lambda (پاسخ‌گو به POST/GET):</div>
  <div class="code-box"><code>
import json, os, boto3, uuid
db = boto3.resource("dynamodb")
table = db.Table(os.environ.get("TABLE","ws-items"))

def lambda_handler(event, context):
    method = (event.get("requestContext") or {}).get("http", {}).get("method") \
             or event.get("httpMethod")
    if method == "POST":
        body = json.loads(event.get("body") or "{}")
        item = {"id": str(uuid.uuid4()), **body}
        table.put_item(Item=item)
        return {"statusCode":201, "headers":{"Content-Type":"application/json"},
                "body": json.dumps(item)}
    if method == "GET":
        params = event.get("pathParameters") or {}
        id_ = params.get("id")
        if not id_:
            return {"statusCode":400,"body":"missing id"}
        res = table.get_item(Key={"id": id_})
        return {"statusCode":200,"headers":{"Content-Type":"application/json"},
                "body": json.dumps(res.get("Item"))}
    return {"statusCode":405,"body":"Method Not Allowed"}
  </code></div>

  <div class="note warn"><b>عیب‌یابی سریع</b>: 403/Permission ➜ ARN جدول درست؛ CORS ➜ اگر از مرورگر فراخوانی می‌کنی در API فعالش کن.</div>

  <hr class="separator">

  <!-- سناریو 3 -->
  <h2>🔹 سناریو 3: EventBridge (زمان‌بندی) ➜ Lambda (پاکسازی فایل‌های قدیمی S3)</h2>

  <div class="note"><b>پیش‌نیاز</b>: باکت S3 مثل <code>ws-media-bucket</code>. نقش Lambda با List/Delete روی باکت/پریفیکس.</div>

  <div class="note"><b>مراحل کنسول</b></div>
  <ul class="steps">
    <li>Lambda ➜ Create function ➜ Name: <code>ws-s3-cleanup</code> ➜ Runtime: Node.js 20 ➜ Role: new basic ➜ Create.</li>
    <li>Lambda ➜ Configuration ➜ Environment: <code>BUCKET = ws-media-bucket</code>، <code>PREFIX = uploads/</code> (اختیاری).</li>
    <li>Lambda ➜ Permissions ➜ Attach policy حداقلی: ListBucket + DeleteObject روی باکت/آبجکت‌ها.</li>
    <li>EventBridge ➜ Schedules ➜ <b>Create schedule</b> ➜ Name: <code>ws-s3-cleanup-daily</code> ➜ Daily (مثلاً 03:00 UTC) ➜ Target: Lambda <code>ws-s3-cleanup</code> ➜ Create.</li>
  </ul>

  <div class="note">کد Lambda (پاکسازی فایل‌های قدیمی‌تر از ۷ روز):</div>
  <div class="code-box"><code>
const AWS = require("aws-sdk");
const s3 = new AWS.S3();
const DAY = 24 * 60 * 60 * 1000;

exports.handler = async () => {
  const Bucket = process.env.BUCKET;
  const Prefix = process.env.PREFIX || "";
  const list = await s3.listObjectsV2({ Bucket, Prefix }).promise();
  const now = Date.now();
  const old = (list.Contents || []).filter(o =>
    (now - new Date(o.LastModified).getTime()) > 7 * DAY
  );
  if (!old.length) return { statusCode:200, body:"no old files" };
  await s3.deleteObjects({
    Bucket, Delete: { Objects: old.map(o => ({ Key:o.Key })) }
  }).promise();
  return { statusCode:200, body:`deleted ${old.length}` };
};
  </code></div>

  <div class="note warn"><b>عیب‌یابی سریع</b>: DeleteObject AccessDenied ➜ Resource با <code>/*</code>؛ Schedule Enabled باشد.</div>

  <hr class="separator">

  <!-- سناریو 4 -->
  <h2>🔹 سناریو 4: Cognito (Pre sign-up) ➜ Auto Confirm + Post Confirmation ➜ SNS</h2>

  <div class="note"><b>پیش‌نیاز</b>: User Pool در Cognito، SNS Topic (مثلاً <code>ws-user-notify</code>) و Subscription ایمیل تایید شده.</div>

  <div class="note"><b>مراحل کنسول</b></div>
  <ul class="steps">
    <li>SNS ➜ Topics ➜ Create topic ➜ Name: <code>ws-user-notify</code> ➜ Create ➜ Create subscription (Email) ➜ ایمیل را Confirm کن.</li>
    <li>Lambda ➜ Create function ➜ Name: <code>ws-cognito-pre-signup</code> ➜ Runtime: Python 3.12 ➜ کد Pre sign-up را دیپلوی کن (پایین).</li>
    <li>Lambda ➜ Create function ➜ Name: <code>ws-cognito-post-confirm</code> ➜ Runtime: Node.js 20 ➜ Env: <code>TOPIC_ARN</code> = ARN تاپیک ➜ Permissions: sns:Publish روی همان ARN ➜ کد پایین را دیپلوی کن.</li>
    <li>Cognito ➜ User Pools ➜ User Pool خودت ➜ Triggers ➜ Pre sign-up = <code>ws-cognito-pre-signup</code>، Post confirmation = <code>ws-cognito-post-confirm</code> ➜ Save.</li>
    <li>تست: ثبت‌نام کاربر ➜ Auto-confirm می‌شود ➜ ایمیل SNS می‌آید.</li>
  </ul>

  <div class="note">کد Pre sign-up (Python):</div>
  <div class="code-box"><code>
def lambda_handler(event, context):
    event["response"]["autoConfirmUser"] = True
    event["response"]["autoVerifyEmail"] = True
    return event
  </code></div>

  <div class="note">کد Post confirmation (Node.js) – ارسال پیام به SNS:</div>
  <div class="code-box"><code>
const AWS = require("aws-sdk");
const sns = new AWS.SNS();

exports.handler = async (event) => {
  const email = event.request.userAttributes.email;
  await sns.publish({
    TopicArn: process.env.TOPIC_ARN,
    Message: `New confirmed user: ${email}`
  }).promise();
  return event;
};
  </code></div>

  <div class="note warn"><b>عیب‌یابی سریع</b>: Trigger اجرا نشد ➜ Region یکسان؛ ایمیل نیامد ➜ Subscription را تأیید کن.</div>

  <hr class="separator">

  <!-- سناریو 5 -->
  <h2>🔹 سناریو 5: API ➜ SNS (Fan-out) ➜ SQS ➜ Lambda (Consumer)</h2>

  <div class="note"><b>پیش‌نیاز</b>: یک SNS Topic (<code>ws-fanout</code>)، دو SQS Queue (<code>ws-q-a</code> / <code>ws-q-b</code>) و Subscription هر دو به تاپیک.</div>

  <div class="note"><b>مراحل کنسول</b></div>
  <ul class="steps">
    <li>SNS ➜ Create topic ➜ Name: <code>ws-fanout</code>.</li>
    <li>SQS ➜ Create queue ➜ <code>ws-q-a</code> و دوباره <code>ws-q-b</code> (Standard).</li>
    <li>در SNS Topic ➜ Create subscription ➜ Protocol: SQS ➜ Endpoint: هر Queue.</li>
    <li>Lambda ➜ Create function ➜ Name: <code>ws-publish</code> ➜ Runtime: Node.js 20 ➜ Env: <code>TOPIC_ARN</code> = ARN تاپیک ➜ Permissions: sns:Publish روی همان ARN ➜ کد Publisher پایین.</li>
    <li>API Gateway ➜ HTTP API ➜ Add integration: Lambda <code>ws-publish</code> ➜ Route: <b>POST /publish</b> ➜ Create.</li>
    <li>Lambda ➜ Create function ➜ Name: <code>ws-consumer</code> ➜ Runtime: Python 3.12 ➜ Triggers ➜ Add: SQS = یکی از Queueها ➜ کد Consumer پایین.</li>
  </ul>

  <div class="note">Publisher (Node.js):</div>
  <div class="code-box"><code>
const AWS = require("aws-sdk");
const sns = new AWS.SNS();

exports.handler = async (event) => {
  const body = JSON.parse(event.body || "{}");
  await sns.publish({
    TopicArn: process.env.TOPIC_ARN,
    Message: JSON.stringify(body)
  }).promise();
  return { statusCode: 200, body: "published" };
};
  </code></div>

  <div class="note">Consumer (Python) – Trigger: SQS:</div>
  <div class="code-box"><code>
import json
def lambda_handler(event, context):
    for rec in event["Records"]:
        msg = json.loads(rec["body"])
        print("Message:", msg)
    return {"ok": True}
  </code></div>

  <div class="note warn"><b>عیب‌یابی سریع</b>: Permissions Publisher = sns:Publish؛ Consumer = Receive/DeleteMessage (معمولاً با تریگر خودکار اضافه می‌شود). برای خطاهای مکرر DLQ تعریف کن.</div>

  <hr class="separator">

</body>
</html>
